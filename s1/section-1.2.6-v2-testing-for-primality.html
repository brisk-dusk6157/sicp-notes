<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-05-21 Sun 18:54 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="author" content="LMG" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content" class="content">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orga44ff39">1. 1.2.6. Example: Testing for Primality (with exercises)</a>
<ul>
<li><a href="#org922cddc">1.1. Searching for Divisors - \(O(\sqrt{n})\) version</a></li>
<li><a href="#orga157279">1.2. The Fermat's Test - \(O(\log{n})\) probabilistic version</a></li>
<li><a href="#org77f9eb8">1.3. Ex 1.21 - Try out the functions</a></li>
<li><a href="#orgeaa9bc2">1.4. Ex 1.22 - Timing the \(O(\sqrt{n})\) version</a></li>
<li><a href="#orgfff38ea">1.5. Ex 1.23 - Optimize the \(O(\sqrt{n})\) version</a></li>
<li><a href="#org5b462ef">1.6. Ex 1.24 - Timing the \(O(\log{n})\) version</a></li>
<li><a href="#org5837ee8">1.7. Ex 1.25 - Would naive expmod work?</a></li>
<li><a href="#org1f8de14">1.8. Ex 1.26 - Why "normal-order"-esque `square turns \(O(\log{n})\) into \(O(n)\)</a></li>
<li><a href="#orgc11382e">1.9. Ex 1.27 - Ensure Carmichael numbers fool the Fermat test</a></li>
<li><a href="#org3b52b9d">1.10. Ex 1.28 - Implement the Miller-Rabin test</a>
<ul>
<li><a href="#orgf4a2a66">1.10.1. Alternate form of the Fermat's Little Theorem:</a></li>
<li><a href="#orgd4e8623">1.10.2. Miller-Rabin test</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orga44ff39" class="outline-2">
<h2 id="orga44ff39"><span class="section-number-2">1.</span> 1.2.6. Example: Testing for Primality (with exercises)</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org922cddc" class="outline-3">
<h3 id="org922cddc"><span class="section-number-3">1.1.</span> Searching for Divisors - \(O(\sqrt{n})\) version</h3>
<div class="outline-text-3" id="text-1-1">
<p>
One way to test if a positive integer \(n\) is a prime is to walk through every integer \(a\), \(a \lt n\), and if some of such \(a\) divides \(n\), then \(n\) is not prime.
</p>

<p>
Idea of the algorithm is to find a smallest divisor of a supposed prime number, and if it's the number itself, then it's prime.
</p>

<p>
Key observation here is that we only need to check such \(a\) that \(a \lt \sqrt{n}\), for if \(a | n\), then also \(\frac{n}{a} | n\), by checking one divisor we also check the other. As it's impossible to have both divisors \(\gt \sqrt{n}\), then it'll suffice to check only first \(\sqrt{n}\).
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgb6b06e2">#lang sicp

(define (square x) (* x x))

(define (prime? n)
  (= (smallest-divisor n) n))

(define (smallest-divisor n)
  (find-divisor n 2))

(define (find-divisor n test-divisor)
  (cond ((&gt; (square test-divisor) n) n)
	((divides? test-divisor n) test-divisor)
	(else (find-divisor n (+ test-divisor 1)))))

(define (divides? d n)
  (= (remainder n d) 0))

</pre>
</div>
</div>
</div>

<div id="outline-container-orga157279" class="outline-3">
<h3 id="orga157279"><span class="section-number-3">1.2.</span> The Fermat's Test - \(O(\log{n})\) probabilistic version</h3>
<div class="outline-text-3" id="text-1-2">
<p>
The \(O(\log{n})\) version is based on the Little Fermat's Theorem.
</p>

<p>
<b>The Little Fermat's Theorem</b>
</p>
<blockquote>
<p>
Let \(n\) and \(a\) be positive integers with \(a \lt n\). Then, if \(n\) is prime, then \(a^n \equiv a \pmod{n}\).
</p>
</blockquote>

<p>
By taking contrapositive, if \(a^n \not\equiv a \pmod{n}\), then \(n\) is not a prime. However, in general, \(a^n \equiv a \pmod{n}\) does not imply that \(n\) is a prime.
</p>

<p>
This gives the idea for a test for whether given \(n\) is a prime: pick some random \(a \lt n\), if \(a^n \not\equiv a \pmod{n}\) then \(n\) is not a prime, otherwise \(n\) is <i>probably</i> a prime. The more such \(a\)'s pass the test, the more likely \(n\) is a prime.
</p>

<p>
This is called <b>the Fermat's test</b>.
</p>

<p>
To implement it, we need an efficient way to compute \(a^n\mod{n}\). Property of congruence used for this is that if \(a \equiv b \pmod{p}\) and \(c \equiv d \pmod{p}\), then \(a \cdot c \equiv b \cdot d \pmod{p}\). It is similar to fast exponentiation in approach, and has \(O(\log{n})\) time complexity.
</p>

<p>
For individual test, random number picked should be between in the \([2, n-1]\) interval. The <code>(random x)</code> primitive returns non-negative integer less then <code>x</code>. So <code>(+ 1 (random (- n 1))</code> will do the job.
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org1796fe3">#lang sicp

(define (expmod base exp m)
  (define (square x) (* x x))
  (cond ((= exp 0) 1)
	((even? exp)
	 (remainder (square (expmod base (/ exp 2) m))
		    m))
	(else
	 (remainder (* base (expmod base (- exp 1) m))
		    m))))

(define (fermat-test n)
  (define (try-it d)
    (= (expmod d n n) d))
  (try-it (+ 1 (random (- n 1)))))

(define (fast-prime? n times)
  (cond ((= 0 times) #t)
	((fermat-test n) (fast-prime? n (dec times)))
	(else #f)))


</pre>
</div>

<p>
The main danger with the Fermat's test is that if it says \(n\) is prime, it's <i>likely</i> true (although, if it says \(n\) is <i>not</i> a prime, it's 100% true). There are numbers, called Carmichael numbers (e.g. 561) that fool the Fermat's test.
</p>
</div>
</div>

<div id="outline-container-org77f9eb8" class="outline-3">
<h3 id="org77f9eb8"><span class="section-number-3">1.3.</span> Ex 1.21 - Try out the functions</h3>
<div class="outline-text-3" id="text-1-3">
<div class="org-src-container">
<pre class="src src-racket">#lang sicp

(define (square x) (* x x))

(define (prime? n)
  (= (smallest-divisor n) n))

(define (smallest-divisor n)
  (find-divisor n 2))

(define (find-divisor n test-divisor)
  (cond ((&gt; (square test-divisor) n) n)
	((divides? test-divisor n) test-divisor)
	(else (find-divisor n (+ test-divisor 1)))))

(define (divides? d n)
  (= (remainder n d) 0))


(smallest-divisor 199)
(smallest-divisor 1999)
(smallest-divisor 19999)

(prime? 199)
(prime? 1999)
(prime? 19999)
</pre>
</div>

<pre class="example">
199
1999
7
#t
#t
#f
</pre>


<div class="org-src-container">
<pre class="src src-racket">#lang sicp

(define (expmod base exp m)
  (define (square x) (* x x))
  (cond ((= exp 0) 1)
	((even? exp)
	 (remainder (square (expmod base (/ exp 2) m))
		    m))
	(else
	 (remainder (* base (expmod base (- exp 1) m))
		    m))))

(define (fermat-test n)
  (define (try-it d)
    (= (expmod d n n) d))
  (try-it (+ 1 (random (- n 1)))))

(define (fast-prime? n times)
  (cond ((= 0 times) #t)
	((fermat-test n) (fast-prime? n (dec times)))
	(else #f)))



(fast-prime? 199 5)
(fast-prime? 1999 5)
(fast-prime? 19999 5)
</pre>
</div>

<pre class="example">
#t
#t
#f
</pre>
</div>
</div>

<div id="outline-container-orgeaa9bc2" class="outline-3">
<h3 id="orgeaa9bc2"><span class="section-number-3">1.4.</span> Ex 1.22 - Timing the \(O(\sqrt{n})\) version</h3>
<div class="outline-text-3" id="text-1-4">
<p>
<code>(runtime)</code> returns an integer that specifies the amount of time the system has been running.
This can be used to measure execution time.
</p>

<div class="org-src-container">
<pre class="src src-racket">#lang sicp

(define (square x) (* x x))

(define (prime? n)
  (= (smallest-divisor n) n))

(define (smallest-divisor n)
  (find-divisor n 2))

(define (find-divisor n test-divisor)
  (cond ((&gt; (square test-divisor) n) n)
	((divides? test-divisor n) test-divisor)
	(else (find-divisor n (+ test-divisor 1)))))

(define (divides? d n)
  (= (remainder n d) 0))


(define (timed-prime-test n)
  (define (time start-time)
    (prime? n)
    (- (runtime) start-time))
  (time (runtime)))

(define (timed-prime-test-avg n times)
  (define (iter sum count)
    (if (= count 0)
	sum
	(iter (+ sum (timed-prime-test n))
	      (dec count))))
  (/ (iter 0 times) (* 1.0 times)))

(define (display-time-measurement n duration)
  (display "|")
  (display n)
  (display "|")
  (display duration)
  (display "|")
  (newline))

(define (search-for-primes n limit)
  (cond ((= limit 0) (display ""))
	((prime? n)
	 (display-time-measurement n (timed-prime-test-avg n 1000))
	 (search-for-primes (+ n 1) (dec limit)))
	(else
	 (search-for-primes (+ n 1) limit))))
(search-for-primes 100000 3)
(search-for-primes 1000000 3)
(search-for-primes 10000000 3)
(search-for-primes 100000000 3)
(search-for-primes 1000000000 3)
(search-for-primes 10000000000 3)
(search-for-primes 100000000000 3)

</pre>
</div>


<table id="org53657e0" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">100003</td>
<td class="org-right">0.933</td>
</tr>

<tr>
<td class="org-right">100019</td>
<td class="org-right">0.918</td>
</tr>

<tr>
<td class="org-right">100043</td>
<td class="org-right">0.91</td>
</tr>

<tr>
<td class="org-right">1000003</td>
<td class="org-right">2.767</td>
</tr>

<tr>
<td class="org-right">1000033</td>
<td class="org-right">2.795</td>
</tr>

<tr>
<td class="org-right">1000037</td>
<td class="org-right">2.768</td>
</tr>

<tr>
<td class="org-right">10000019</td>
<td class="org-right">8.637</td>
</tr>

<tr>
<td class="org-right">10000079</td>
<td class="org-right">8.615</td>
</tr>

<tr>
<td class="org-right">10000103</td>
<td class="org-right">8.608</td>
</tr>

<tr>
<td class="org-right">100000007</td>
<td class="org-right">27.17</td>
</tr>

<tr>
<td class="org-right">100000037</td>
<td class="org-right">27.139</td>
</tr>

<tr>
<td class="org-right">100000039</td>
<td class="org-right">27.309</td>
</tr>

<tr>
<td class="org-right">1000000007</td>
<td class="org-right">86.77</td>
</tr>

<tr>
<td class="org-right">1000000009</td>
<td class="org-right">86.236</td>
</tr>

<tr>
<td class="org-right">1000000021</td>
<td class="org-right">86.75</td>
</tr>

<tr>
<td class="org-right">10000000019</td>
<td class="org-right">279.596</td>
</tr>

<tr>
<td class="org-right">10000000033</td>
<td class="org-right">271.998</td>
</tr>

<tr>
<td class="org-right">10000000061</td>
<td class="org-right">272.127</td>
</tr>

<tr>
<td class="org-right">100000000003</td>
<td class="org-right">859.095</td>
</tr>

<tr>
<td class="org-right">100000000019</td>
<td class="org-right">862.939</td>
</tr>

<tr>
<td class="org-right">100000000057</td>
<td class="org-right">859.008</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-racket">(sqrt 10)
(/ 860.0 272.0)
(/ 272.0 86.7)
(/ 86.7 27.3)
(/ 27.3 8.6)
(/ 8.6 2.7)
</pre>
</div>

<pre class="example">
3.1622776601683795
3.161764705882353
3.1372549019607843
3.1758241758241756
3.174418604651163
3.1851851851851847
</pre>


<p>
10-fold increase in input yields an execution time increase very close to \(\sqrt{10}\), which is in line with the our expectations.
</p>
</div>
</div>


<div id="outline-container-orgfff38ea" class="outline-3">
<h3 id="orgfff38ea"><span class="section-number-3">1.5.</span> Ex 1.23 - Optimize the \(O(\sqrt{n})\) version</h3>
<div class="outline-text-3" id="text-1-5">
<div class="org-src-container">
<pre class="src src-racket">#lang sicp

(define (square x) (* x x))

(define (prime? n)
  (= (smallest-divisor-opt-2 n) n))

(define (smallest-divisor-orig n)
  (find-divisor-opt-1 n 2))

(define (smallest-divisor-opt-2 n)
  (find-divisor-opt-2 n 3))

(define (find-divisor-orig n test-divisor)
  (cond ((&gt; (square test-divisor) n) n)
	((divides? test-divisor n) test-divisor)
	(else (find-divisor n (+ test-divisor 1)))))

(define (find-divisor-opt-1 n test-divisor)
  (cond ((&gt; (square test-divisor) n) n)
	((divides? test-divisor n) test-divisor)
	(else (find-divisor n (if (= test-divisor 2) 3 (+ test-divisor 2))))))

(define (find-divisor-opt-2 n test-divisor)
  (cond ((&gt; (square test-divisor) n) n)
	((divides? test-divisor n) test-divisor)
	(else (find-divisor n (+ test-divisor 2)))))

(define (divides? d n)
  (= (remainder n d) 0))

(define (timed-prime-test n)
  (define (time start-time)
    (prime? n)
    (- (runtime) start-time))
  (time (runtime)))

(define (timed-prime-test-avg n times)
  (define (iter sum count)
    (if (= count 0)
	sum
	(iter (+ sum (timed-prime-test n))
	      (dec count))))
  (/ (iter 0 times) (* 1.0 times)))

(define (display-time-measurement n duration)
  (display "|")
  (display n)
  (display "|")
  (display duration)
  (display "|")
  (newline))

(define (search-for-primes n limit)
  (cond ((= limit 0) (display ""))
	((prime? n)
	 (display-time-measurement n (timed-prime-test-avg n 1000))
	 (search-for-primes (+ n 1) (dec limit)))
	(else
	 (search-for-primes (+ n 1) limit))))
(search-for-primes 100000 3)
(search-for-primes 1000000 3)
(search-for-primes 10000000 3)
(search-for-primes 100000000 3)
(search-for-primes 1000000000 3)
(search-for-primes 10000000000 3)
(search-for-primes 100000000000 3)

</pre>
</div>


<table id="org136f76f" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">prime</th>
<th scope="col" class="org-right">t-seq (ms)</th>
<th scope="col" class="org-right">t-seq-opt (ms)</th>
<th scope="col" class="org-right">t-seq-opt-2 (ms)</th>
<th scope="col" class="org-right">rat-opt</th>
<th scope="col" class="org-right">rat-opt-2</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">100003</td>
<td class="org-right">0.933</td>
<td class="org-right">0.524</td>
<td class="org-right">0.517</td>
<td class="org-right">1.78</td>
<td class="org-right">1.8</td>
</tr>

<tr>
<td class="org-right">100019</td>
<td class="org-right">0.918</td>
<td class="org-right">0.538</td>
<td class="org-right">0.513</td>
<td class="org-right">1.71</td>
<td class="org-right">1.79</td>
</tr>

<tr>
<td class="org-right">100043</td>
<td class="org-right">0.91</td>
<td class="org-right">0.537</td>
<td class="org-right">0.48</td>
<td class="org-right">1.69</td>
<td class="org-right">1.9</td>
</tr>

<tr>
<td class="org-right">1000003</td>
<td class="org-right">2.767</td>
<td class="org-right">1.555</td>
<td class="org-right">1.469</td>
<td class="org-right">1.78</td>
<td class="org-right">1.88</td>
</tr>

<tr>
<td class="org-right">1000033</td>
<td class="org-right">2.795</td>
<td class="org-right">1.551</td>
<td class="org-right">1.427</td>
<td class="org-right">1.8</td>
<td class="org-right">1.96</td>
</tr>

<tr>
<td class="org-right">1000037</td>
<td class="org-right">2.768</td>
<td class="org-right">1.557</td>
<td class="org-right">1.471</td>
<td class="org-right">1.78</td>
<td class="org-right">1.88</td>
</tr>

<tr>
<td class="org-right">10000019</td>
<td class="org-right">8.637</td>
<td class="org-right">4.788</td>
<td class="org-right">4.508</td>
<td class="org-right">1.8</td>
<td class="org-right">1.92</td>
</tr>

<tr>
<td class="org-right">10000079</td>
<td class="org-right">8.615</td>
<td class="org-right">4.789</td>
<td class="org-right">4.528</td>
<td class="org-right">1.8</td>
<td class="org-right">1.9</td>
</tr>

<tr>
<td class="org-right">10000103</td>
<td class="org-right">8.608</td>
<td class="org-right">4.778</td>
<td class="org-right">4.508</td>
<td class="org-right">1.8</td>
<td class="org-right">1.91</td>
</tr>

<tr>
<td class="org-right">100000007</td>
<td class="org-right">27.17</td>
<td class="org-right">15.055</td>
<td class="org-right">14.184</td>
<td class="org-right">1.8</td>
<td class="org-right">1.92</td>
</tr>

<tr>
<td class="org-right">100000037</td>
<td class="org-right">27.139</td>
<td class="org-right">15.034</td>
<td class="org-right">14.17</td>
<td class="org-right">1.81</td>
<td class="org-right">1.92</td>
</tr>

<tr>
<td class="org-right">100000039</td>
<td class="org-right">27.309</td>
<td class="org-right">15.039</td>
<td class="org-right">14.162</td>
<td class="org-right">1.82</td>
<td class="org-right">1.93</td>
</tr>

<tr>
<td class="org-right">1000000007</td>
<td class="org-right">86.77</td>
<td class="org-right">47.541</td>
<td class="org-right">44.719</td>
<td class="org-right">1.83</td>
<td class="org-right">1.94</td>
</tr>

<tr>
<td class="org-right">1000000009</td>
<td class="org-right">86.236</td>
<td class="org-right">47.623</td>
<td class="org-right">44.785</td>
<td class="org-right">1.81</td>
<td class="org-right">1.93</td>
</tr>

<tr>
<td class="org-right">1000000021</td>
<td class="org-right">86.75</td>
<td class="org-right">48.233</td>
<td class="org-right">45.291</td>
<td class="org-right">1.8</td>
<td class="org-right">1.92</td>
</tr>

<tr>
<td class="org-right">10000000019</td>
<td class="org-right">279.596</td>
<td class="org-right">151.363</td>
<td class="org-right">138.577</td>
<td class="org-right">1.85</td>
<td class="org-right">2.02</td>
</tr>

<tr>
<td class="org-right">10000000033</td>
<td class="org-right">271.998</td>
<td class="org-right">151.311</td>
<td class="org-right">136.069</td>
<td class="org-right">1.8</td>
<td class="org-right">2.0</td>
</tr>

<tr>
<td class="org-right">10000000061</td>
<td class="org-right">272.127</td>
<td class="org-right">151.024</td>
<td class="org-right">136.114</td>
<td class="org-right">1.8</td>
<td class="org-right">2.0</td>
</tr>

<tr>
<td class="org-right">100000000003</td>
<td class="org-right">859.095</td>
<td class="org-right">475.512</td>
<td class="org-right">430.351</td>
<td class="org-right">1.81</td>
<td class="org-right">2.0</td>
</tr>

<tr>
<td class="org-right">100000000019</td>
<td class="org-right">862.939</td>
<td class="org-right">475.617</td>
<td class="org-right">429.859</td>
<td class="org-right">1.81</td>
<td class="org-right">2.01</td>
</tr>

<tr>
<td class="org-right">100000000057</td>
<td class="org-right">859.008</td>
<td class="org-right">475.643</td>
<td class="org-right">430.389</td>
<td class="org-right">1.81</td>
<td class="org-right">2.0</td>
</tr>
</tbody>
</table>

<p>
So this is not exactly 2x increase, more like 1.8x, bet we added <code>if</code> and it probably eats into the time. As <code>search-for-prime</code> calls <code>timed-prime-test</code> only for primes, remove <code>if</code> and assume it starts divisor search from 3.
</p>

<p>
And indeed, with that <code>if</code> removed, <code>rat-opt-2</code> is much closer to $2$x than <code>rat-opt</code>.
</p>
</div>
</div>

<div id="outline-container-org5b462ef" class="outline-3">
<h3 id="org5b462ef"><span class="section-number-3">1.6.</span> Ex 1.24 - Timing the \(O(\log{n})\) version</h3>
<div class="outline-text-3" id="text-1-6">
<p>
For larger values of prime, <code>(random n)</code> fails, so I'll consider only those prime below \(4.2*10^9\). Is this a real limitation of <code>fast-prime?</code>? How do you select a large random number (e.g. is randomly selecting two digits separatly and combining them into 2-digit number the same as randomly selecting 2-digit number?)
</p>

<div class="org-src-container">
<pre class="src src-racket">#lang sicp

(define (expmod base exp m)
  (define (square x) (* x x))
  (cond ((= exp 0) 1)
	((even? exp)
	 (remainder (square (expmod base (/ exp 2) m))
		    m))
	(else
	 (remainder (* base (expmod base (- exp 1) m))
		    m))))

(define (fermat-test n)
  (define (try-it d)
    (= (expmod d n n) d))
  (try-it (+ 1 (random (- n 1)))))

(define (fast-prime? n times)
  (cond ((= 0 times) #t)
	((fermat-test n) (fast-prime? n (dec times)))
	(else #f)))



(define (timed-prime-test n)
  (define (time start-time)
    (fast-prime? n 5)
    (- (runtime) start-time))
  (time (runtime)))

(define (timed-prime-test-avg n times)
  (define (iter sum count)
    (if (= count 0)
	sum
	(iter (+ sum (timed-prime-test n))
	      (dec count))))
  (/ (iter 0 times) (* 1.0 times)))

(define (display-time-measurement n duration)
  (display "|")
  (display n)
  (display "|")
  (display duration)
  (display "|")
  (newline))

(define (search-for-primes n limit)
  (cond ((= limit 0) (display ""))
	((fast-prime? n 5)
	 (display-time-measurement n (timed-prime-test-avg n 1000))
	 (search-for-primes (+ n 1) (dec limit)))
	(else
	 (search-for-primes (+ n 1) limit))))
(search-for-primes 100000 3)
(search-for-primes 1000000 3)
(search-for-primes 10000000 3)
(search-for-primes 100000000 3)
(search-for-primes 1000000000 3)

</pre>
</div>

<table id="org7a85af3" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">prime</th>
<th scope="col" class="org-right">t-seq (ms)</th>
<th scope="col" class="org-right">t-seq-opt (ms)</th>
<th scope="col" class="org-right">t-seq-opt-2 (ms)</th>
<th scope="col" class="org-right">t-fast (ms)</th>
<th scope="col" class="org-right">rat-opt</th>
<th scope="col" class="org-right">rat-opt-2</th>
<th scope="col" class="org-right">rat-fast</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">100003</td>
<td class="org-right">0.933</td>
<td class="org-right">0.524</td>
<td class="org-right">0.517</td>
<td class="org-right">1.25</td>
<td class="org-right">1.78</td>
<td class="org-right">1.8</td>
<td class="org-right">0.75</td>
</tr>

<tr>
<td class="org-right">100019</td>
<td class="org-right">0.918</td>
<td class="org-right">0.538</td>
<td class="org-right">0.513</td>
<td class="org-right">1.288</td>
<td class="org-right">1.71</td>
<td class="org-right">1.79</td>
<td class="org-right">0.71</td>
</tr>

<tr>
<td class="org-right">100043</td>
<td class="org-right">0.91</td>
<td class="org-right">0.537</td>
<td class="org-right">0.48</td>
<td class="org-right">1.284</td>
<td class="org-right">1.69</td>
<td class="org-right">1.9</td>
<td class="org-right">0.71</td>
</tr>

<tr>
<td class="org-right">1000003</td>
<td class="org-right">2.767</td>
<td class="org-right">1.555</td>
<td class="org-right">1.469</td>
<td class="org-right">1.514</td>
<td class="org-right">1.78</td>
<td class="org-right">1.88</td>
<td class="org-right">1.83</td>
</tr>

<tr>
<td class="org-right">1000033</td>
<td class="org-right">2.795</td>
<td class="org-right">1.551</td>
<td class="org-right">1.427</td>
<td class="org-right">1.423</td>
<td class="org-right">1.8</td>
<td class="org-right">1.96</td>
<td class="org-right">1.96</td>
</tr>

<tr>
<td class="org-right">1000037</td>
<td class="org-right">2.768</td>
<td class="org-right">1.557</td>
<td class="org-right">1.471</td>
<td class="org-right">1.47</td>
<td class="org-right">1.78</td>
<td class="org-right">1.88</td>
<td class="org-right">1.88</td>
</tr>

<tr>
<td class="org-right">10000019</td>
<td class="org-right">8.637</td>
<td class="org-right">4.788</td>
<td class="org-right">4.508</td>
<td class="org-right">1.698</td>
<td class="org-right">1.8</td>
<td class="org-right">1.92</td>
<td class="org-right">5.09</td>
</tr>

<tr>
<td class="org-right">10000079</td>
<td class="org-right">8.615</td>
<td class="org-right">4.789</td>
<td class="org-right">4.528</td>
<td class="org-right">1.775</td>
<td class="org-right">1.8</td>
<td class="org-right">1.9</td>
<td class="org-right">4.85</td>
</tr>

<tr>
<td class="org-right">10000103</td>
<td class="org-right">8.608</td>
<td class="org-right">4.778</td>
<td class="org-right">4.508</td>
<td class="org-right">1.76</td>
<td class="org-right">1.8</td>
<td class="org-right">1.91</td>
<td class="org-right">4.89</td>
</tr>

<tr>
<td class="org-right">100000007</td>
<td class="org-right">27.17</td>
<td class="org-right">15.055</td>
<td class="org-right">14.184</td>
<td class="org-right">1.955</td>
<td class="org-right">1.8</td>
<td class="org-right">1.92</td>
<td class="org-right">13.9</td>
</tr>

<tr>
<td class="org-right">100000037</td>
<td class="org-right">27.139</td>
<td class="org-right">15.034</td>
<td class="org-right">14.17</td>
<td class="org-right">2.026</td>
<td class="org-right">1.81</td>
<td class="org-right">1.92</td>
<td class="org-right">13.4</td>
</tr>

<tr>
<td class="org-right">100000039</td>
<td class="org-right">27.309</td>
<td class="org-right">15.039</td>
<td class="org-right">14.162</td>
<td class="org-right">2.026</td>
<td class="org-right">1.82</td>
<td class="org-right">1.93</td>
<td class="org-right">13.48</td>
</tr>

<tr>
<td class="org-right">1000000007</td>
<td class="org-right">86.77</td>
<td class="org-right">47.541</td>
<td class="org-right">44.719</td>
<td class="org-right">2.172</td>
<td class="org-right">1.83</td>
<td class="org-right">1.94</td>
<td class="org-right">39.95</td>
</tr>

<tr>
<td class="org-right">1000000009</td>
<td class="org-right">86.236</td>
<td class="org-right">47.623</td>
<td class="org-right">44.785</td>
<td class="org-right">2.135</td>
<td class="org-right">1.81</td>
<td class="org-right">1.93</td>
<td class="org-right">40.39</td>
</tr>

<tr>
<td class="org-right">1000000021</td>
<td class="org-right">86.75</td>
<td class="org-right">48.233</td>
<td class="org-right">45.291</td>
<td class="org-right">2.189</td>
<td class="org-right">1.8</td>
<td class="org-right">1.92</td>
<td class="org-right">39.63</td>
</tr>
</tbody>
</table>


<p>
With calculated constant - \(c = \frac{\sqrt{n}}{\log_{2}{n}} \cdot \frac{1}{r}\), where \(r = \frac{t_{seq}}{t_{fast}}\):
</p>
</div>
</div>

<div id="outline-container-org5837ee8" class="outline-3">
<h3 id="org5837ee8"><span class="section-number-3">1.7.</span> Ex 1.25 - Would naive expmod work?</h3>
<div class="outline-text-3" id="text-1-7">
<p>
Suggested expmod implementation:
</p>
<div class="org-src-container">
<pre class="src src-racket">#lang sicp

;; used
(define (expmod base exp m)
  (cond ((= exp 0) 1)
	((even? exp) (remainder (square (expmod base (/ exp 2) m)) m))
	(else (remainder (* base (expmod base (- exp 1) m)) m))))

;; suggested by Alyssa P. Hacker
(define (expmod-alyssa base exp m)
  (remainder (fast-expt base exp) m))
</pre>
</div>

<p>
One of the test steps is <code>(expmod m p p)</code>, where <code>p</code> is a prime and <code>m &lt; p</code> is some integer.
The option suggested by Alyssa would work for checking very small primes p, as then <code>(fast-expt m p)</code> would fit into usual number boundaries.
However, with anything a bit larger it would fail already with either boundary checks or arithmetic overflows.
</p>
</div>
</div>

<div id="outline-container-org1f8de14" class="outline-3">
<h3 id="org1f8de14"><span class="section-number-3">1.8.</span> Ex 1.26 - Why "normal-order"-esque `square turns \(O(\log{n})\) into \(O(n)\)</h3>
<div class="outline-text-3" id="text-1-8">
<p>
Louis Reasoner's version of <code>expmod</code>:
</p>
<div class="org-src-container">
<pre class="src src-racket">#lang sicp

(define (expmod base exp m)
  (cond ((= exp 0) 1)
	((even? exp)
	 (remainder (* (expmod base (/ exp 2) m)
		       (expmod base (/ exp 2) m))
		    m))
	(else
	 (remainder (* base (expmod base (- exp 1) m))
		    m))))
</pre>
</div>

<p>
Example:
</p>
<div class="org-src-container">
<pre class="src src-racket">;; instead of
 (expmod 2 8 3)
  (expmod 2 4 3)
   (expmod 2 2 3)
     (expmod 2 1 3)
      (expmod 2 0 3)

;; this tree would be calculated
 (expmod 2 8 3)
  (expmod 2 4 3)
   (expmod 2 2 3)
     (expmod 2 1 3)
      (expmod 2 0 3)
     (expmod 2 1 3)
      (expmod 2 0 3)
   (expmod 2 2 3)
     (expmod 2 1 3)
      (expmod 2 0 3)
     (expmod 2 1 3)
      (expmod 2 0 3)
  (expmod 2 4 3)
   (expmod 2 2 3)
     (expmod 2 1 3)
      (expmod 2 0 3)
     (expmod 2 1 3)
      (expmod 2 0 3)
   (expmod 2 2 3)
     (expmod 2 1 3)
      (expmod 2 0 3)
     (expmod 2 1 3)
      (expmod 2 0 3)

</pre>
</div>

<p>
Let \(f(n)\) denote the number of operations performed for input \(n\). For conveniece take \(n=2^k\) for some \(k\). Now on each step <code>expmod</code> is calculated twice with halfed input <code>n/2</code>, so \(f(n)=2f(n/2)=4f(n/4)=...=2^kf(1)=2^k=n\) (assuming \(f(1)\) is constant). So the number of steps to calculate <code>expmod</code> for <code>n</code>-th power is \(\theta(n)\)
</p>
</div>
</div>

<div id="outline-container-orgc11382e" class="outline-3">
<h3 id="orgc11382e"><span class="section-number-3">1.9.</span> Ex 1.27 - Ensure Carmichael numbers fool the Fermat test</h3>
<div class="outline-text-3" id="text-1-9">
<p>
Carmichael number is a non-prime number \(n\) such that for each \(a < n\), \(a^n \equiv a \pmod{n}\).
</p>

<p>
Below is a procedure to test out some known Carmichael numbers:
</p>

<div class="org-src-container">
<pre class="src src-racket">#lang sicp

(define (expmod base exp m)
  (define (square x) (* x x))
  (cond ((= exp 0) 1)
	((even? exp)
	 (remainder (square (expmod base (/ exp 2) m))
		    m))
	(else
	 (remainder (* base (expmod base (- exp 1) m))
		    m))))

(define (fermat-test n)
  (define (try-it d)
    (= (expmod d n n) d))
  (try-it (+ 1 (random (- n 1)))))

(define (fast-prime? n times)
  (cond ((= 0 times) #t)
	((fermat-test n) (fast-prime? n (dec times)))
	(else #f)))



(define (fermat-vs-carmichael n)
  (define (iter a)
    (cond ((= a n) #t)
	  ((not (eq? (expmod a n n) a)) #f)
	  (else (iter (inc a)))))
  (iter 2))

;; ensure it fails for obviously composite non-Carmichael number
(fermat-vs-carmichael 562)

(fermat-vs-carmichael 561)
(fermat-vs-carmichael 1105)
(fermat-vs-carmichael 1729)
(fermat-vs-carmichael 2465)

</pre>
</div>
</div>
</div>

<div id="outline-container-org3b52b9d" class="outline-3">
<h3 id="org3b52b9d"><span class="section-number-3">1.10.</span> Ex 1.28 - Implement the Miller-Rabin test</h3>
<div class="outline-text-3" id="text-1-10">
</div>
<div id="outline-container-orgf4a2a66" class="outline-4">
<h4 id="orgf4a2a66"><span class="section-number-4">1.10.1.</span> Alternate form of the Fermat's Little Theorem:</h4>
<div class="outline-text-4" id="text-1-10-1">
<blockquote>
<p>
If \(n\) is a prime number and \(a\) is any positive integer less than \(n\) (so that \((a,n)=1\)), then \(a^{n-1} \equiv 1 \pmod{n}\).
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orgd4e8623" class="outline-4">
<h4 id="orgd4e8623"><span class="section-number-4">1.10.2.</span> Miller-Rabin test</h4>
<div class="outline-text-4" id="text-1-10-2">
<p>
Pick random \(a \lt n\),  <code>(expmod a (- n 1) n)</code>.
</p>

<p>
When performing the squaring step in <code>expmod</code>, check if a "nontrivial square root of 1 modulo n" is discovered (that is a number not equal to \(1\) or \(n-1\), whose square is equal to \(1\mod{n}\). It is possible to prove that if such a nontrivial square root of 1 exists, then \(n\) is not prime.
</p>

<p>
It is also possible to prove that if n is an odd number that is not prime, then for at least half the numbers \(a < n\), computing \(a^{n-1}\) in that way will reveal a nontrivial square root of 1 module n).
</p>

<div class="org-src-container">
<pre class="src src-racket">#lang sicp

(define (square x) (* x x))

(define (expmod-mr base exp m)
  (define (mr-check s)
    (if (and (not (eq? s 1))
	     (not (eq? s (- m 1)))
	     (= 1 (remainder (square s) m)))
	0 ;; signal that nontrivial square root of 1 modulo n is found
	(remainder (square s) m)))

  (cond ((zero? exp) 1)
	((even? exp)
	 (mr-check (expmod-mr base (/ exp 2) m)))
	(else
	 (remainder (* base (expmod-mr base (dec exp) m))
		    m))))

(define (miller-rabin-test n)
  (define (try-it a)
    (= (expmod-mr a (- n 1) n) 1))
  (try-it (+ 1 (random (- n 1)))))

(define (fast-robust-prime? n count)
  (cond ((zero? count) #t)
	((miller-rabin-test n) (fast-robust-prime? n (dec count)))
	(else #f)))

(fast-robust-prime? 1729 5)
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: LMG</p>
<p class="date">Created: 2023-05-21 Sun 18:54</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
