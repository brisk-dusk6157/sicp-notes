<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-07-23 Sun 23:49 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>3 Modularity, Objects and State</title>
<meta name="author" content="LMG" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">3 Modularity, Objects and State</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org3474207">Intro</a></li>
<li><a href="#orga4272e3">3.1 Assignment and Local State</a>
<ul>
<li><a href="#org2f67169">3.1.1 Local State Variables</a>
<ul>
<li><a href="#org0ff72c3">Exercise 3.1 - accumulator</a></li>
<li><a href="#orged6b536">Exercise 3.2 - <code>make-monitored</code></a></li>
<li><a href="#orgc59203b">Exercise 3.3 - password-protected accounts</a></li>
<li><a href="#org1fbf9f4">Exercise 3.4 - password-protected accounts with cops</a></li>
</ul>
</li>
<li><a href="#org5583c9b">3.1.2 The Benefits of Introducing Assignment</a>
<ul>
<li><a href="#org522463f">Exercise 3.5 - Monte Carlo integration</a></li>
<li><a href="#org07736d3">Exercise 3.6 - rand reset</a></li>
</ul>
</li>
<li><a href="#org0add444">3.1.2 The Costs of Introducing Assignment</a>
<ul>
<li><a href="#orgfcc4304">Sameness and change</a></li>
<li><a href="#orge5fd51d">Pitfalls of imperative programming</a></li>
<li><a href="#org2c19e1a">Exercise 3.7 - joint account</a></li>
<li><a href="#org727f42c">Exercise 3.8 - order of evaluation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgf2a2c4f">3.2 The Environment Model of Evaluation</a>
<ul>
<li><a href="#org89e2e53">3.2.1 The Rules for Evaluation</a></li>
<li><a href="#org1a6fa67">3.2.2 Applying Simple Procedures</a></li>
<li><a href="#orgbb51c4e">3.2.3 Frames as the Repository of Local State</a></li>
<li><a href="#org018f5f1">3.2.4 Internal Definitions</a></li>
</ul>
</li>
<li><a href="#org9f1ce79">3.3 Modeling with Mutable Data</a>
<ul>
<li><a href="#org3b304fd">3.3.1 Mutable List Structure</a>
<ul>
<li><a href="#orgd731660">Exercise 3.13</a></li>
<li><a href="#org8633553">Exercise 3.14</a></li>
<li><a href="#org342f5c8">Sharing and Identity</a></li>
<li><a href="#org6301f3f">Exercise 3.15, 3.16</a></li>
<li><a href="#orge2cbf81">Exercise 3.17 - count pairs in structure</a></li>
<li><a href="#org1446cc1">Exercise 3.18 - detect cycle</a></li>
<li><a href="#org71f8dab">Exercise 3.19 - detect cycle in constant space</a></li>
<li><a href="#org5d95462">Mutation is just assignment</a></li>
<li><a href="#org8112892">Exercise 3.20 - environment diagrams for <code>cons</code></a></li>
</ul>
</li>
<li><a href="#org39e1014">3.3.2 Representing Queues</a>
<ul>
<li><a href="#org98ef365">Exercise 3.21 - queue print representation</a></li>
<li><a href="#orgf5ded57">Exercise 3.23 - <i>deque</i></a></li>
</ul>
</li>
<li><a href="#org5359ded">3.3.3 Representing Tables</a>
<ul>
<li><a href="#org60db020">One-dimensional table</a></li>
<li><a href="#org9ffdc0d">Two-dimensional tables</a></li>
<li><a href="#org099459c">Creating local tables</a></li>
<li><a href="#orgcc67343">Exercise 3.24 - user-provided key comparison function</a></li>
<li><a href="#orgd0a542d">Exercise 3.25 - table-x</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org3474207" class="outline-2">
<h2 id="org3474207">Intro</h2>
<div class="outline-text-2" id="text-org3474207">
<p>
In previous chapters we introduced:
</p>
<ul class="org-ul">
<li>basic elements from which programs are made</li>
<li>how to combine primitives to construct compound entities</li>
<li>abstraction is vital to cope with complexity of large systems</li>
</ul>

<p>
But these are not sufficient for designing programs.
</p>

<p>
Effective program synthesis also requires an organizational principles that can guide us in formulating overall design of the system.
</p>


<p>
Effective program synthesis requires organizational principles that can guide us in formulating overall design of a program.
</p>

<p>
In particular, we need strategies to help us structure large system so the they are <i>modular</i>, that is, so that they are divided "naturally" into coherent parts that can be developed and maintained separately.
</p>

<p>
One (what are the others Gerald??) powerful design strategy, is to base the structure of a program on the structure of the system being modelled. For each object in the system we construct corresponding computational object. For each system action we define a symbolic operation in our computational model.
</p>

<p>
Our hope in using this strategy is that extending the model to accomodate new objects or new actions will require no strategic changes to the program, only the addition of the new symbolic analogs of those objects or actions. If we are successful in our system organization, then to add a new feature or debug an old one we will have to work in a localized part of the system.
</p>

<p>
To a large extent the way we orgnize programs depends on our perception of the systems being modelled. In this chapter we will investigate two organizational strategies arising from two different "world views" of the structure of systems.
</p>

<p>
First organizational strategy concentrates on <i>objects</i>, viewing a large system as a collection of objects whose behavior may change over time.
</p>

<p>
An alternative organizational strategy concentrates on the <i>streams</i> of information that flow in the system.
</p>
</div>
</div>

<div id="outline-container-orga4272e3" class="outline-2">
<h2 id="orga4272e3">3.1 Assignment and Local State</h2>
<div class="outline-text-2" id="text-orga4272e3">
<p>
We ordinarily view the world as populated by independent objects, each of which has a state that changes over time. An object is said to "have state" if its history influences its behavior. Object's state can be characterized by one or more <i>state variables</i>.
</p>

<p>
In a system composed of many objects, the objects are rarely completely independent. Each may influence the states of others through interactions, which servie to couple the state variables of one object to those of another.
</p>

<p>
If we choose to model the flow of time in the system by the elapsed time in the computer, then we must have a way to construct computational objects whose behaviors change as our programs run.
</p>
</div>

<div id="outline-container-org2f67169" class="outline-3">
<h3 id="org2f67169">3.1.1 Local State Variables</h3>
<div class="outline-text-3" id="text-org2f67169">
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">balance</span> <span style="color: #D0372D;">100</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">withdraw</span> amount<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">&gt;=</span> balance amount<span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span><span style="color: #0000FF;">begin</span> <span style="color: #709870;">(</span><span style="color: #0000FF;">set!</span> balance <span style="color: #907373;">(</span><span style="color: #006FE0;">-</span> balance amount<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
             balance<span style="color: #909183;">)</span>
      <span style="color: #008000;">"Insufficient funds"</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
<code>balance</code> is global and could be modified by anyone,
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">new-withdraw</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #BA36A5;">balance</span> <span style="color: #D0372D;">100</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>amount<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">&gt;=</span> balance amount<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span><span style="color: #0000FF;">begin</span> <span style="color: #6276BA;">(</span><span style="color: #0000FF;">set!</span> balance <span style="color: #858580;">(</span><span style="color: #006FE0;">-</span> balance amount<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                 balance<span style="color: #907373;">)</span>
          <span style="color: #008000;">"Insufficient funds"</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #0000FF;">#lang</span> <span style="color: #BA36A5;">sicp</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-withdraw</span> balance<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #909183;">(</span>amount<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">&gt;=</span> balance amount<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span><span style="color: #0000FF;">begin</span> <span style="color: #907373;">(</span><span style="color: #0000FF;">set!</span> balance <span style="color: #6276BA;">(</span><span style="color: #006FE0;">-</span> balance amount<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
               balance<span style="color: #709870;">)</span>
        <span style="color: #008000;">"Insufficient funds"</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">W1</span> <span style="color: #7388D6;">(</span>make-withdraw <span style="color: #D0372D;">100</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">W2</span> <span style="color: #7388D6;">(</span>make-withdraw <span style="color: #D0372D;">100</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>W1 <span style="color: #D0372D;">50</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>W2 <span style="color: #D0372D;">70</span><span style="color: #707183;">)</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-racket"><span style="color: #0000FF;">#lang</span> <span style="color: #BA36A5;">sicp</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-account</span> balance<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">withdraw</span> amount<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">&gt;=</span> balance amount<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span><span style="color: #0000FF;">begin</span> <span style="color: #907373;">(</span><span style="color: #0000FF;">set!</span> balance <span style="color: #6276BA;">(</span><span style="color: #006FE0;">-</span> balance amount<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
               balance<span style="color: #709870;">)</span>
        <span style="color: #008000;">"Insufficient funds"</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">deposit</span> amount<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">set!</span> balance <span style="color: #709870;">(</span><span style="color: #006FE0;">+</span> balance amount<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    balance<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">dispatch</span> m<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'withdraw</span><span style="color: #907373;">)</span> withdraw<span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'deposit</span><span style="color: #907373;">)</span> deposit<span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #0000FF;">else</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">error</span> <span style="color: #008000;">"Unknown request -- MAKE-ACCOUNT"</span> m<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  dispatch<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">a</span> <span style="color: #7388D6;">(</span>make-account <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>a <span style="color: #D0372D;">'deposit</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">100</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>a <span style="color: #D0372D;">'deposit</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">50</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>a <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">120</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>a <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">100</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>a <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">30</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>

<div id="outline-container-org0ff72c3" class="outline-4">
<h4 id="org0ff72c3">Exercise 3.1 - accumulator</h4>
<div class="outline-text-4" id="text-org0ff72c3">
<p>
An <i>accumulator</i> is a function of one numeric argument, when called repeatedly accumulates it's arguments into a sum. Each time it is called it returns the currently accumulated sum.
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-accumulator</span> sum<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #909183;">(</span>arg<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">set!</span> sum <span style="color: #709870;">(</span><span style="color: #006FE0;">+</span> sum arg<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    sum<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">acc</span> <span style="color: #7388D6;">(</span>make-accumulator <span style="color: #D0372D;">10</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>acc <span style="color: #D0372D;">20</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>acc <span style="color: #D0372D;">30</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orged6b536" class="outline-4">
<h4 id="orged6b536">Exercise 3.2 - <code>make-monitored</code></h4>
<div class="outline-text-4" id="text-orged6b536">
<p>
Write a procedure <code>make-monitored</code> that takes as input a procedure, f, that itself takes one input. The result returned by <code>make-monitored</code> is a third procedure, say <code>mf</code>, tat keeps track of the number of times it has been called by maintaining an internal counter.
</p>

<p>
If the input to <code>mf</code> is the special symbol <code>how-many-calls?</code>, then <code>mf</code> returns the value of the counter.
If the input to <code>mf</code> is the special symbol <code>reset-count</code> them <code>mf</code> resets the counter to zero.
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org061d3c0"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-monitored</span> f<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #BA36A5;">cnt</span> <span style="color: #D0372D;">0</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #709870;">(</span><span style="color: #006699;">mf</span> x<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">eq?</span> x <span style="color: #D0372D;">'how-many-calls?</span><span style="color: #6276BA;">)</span> cnt<span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">eq?</span> x <span style="color: #D0372D;">'reset-counter</span><span style="color: #6276BA;">)</span>
             <span style="color: #6276BA;">(</span><span style="color: #0000FF;">set!</span> cnt <span style="color: #D0372D;">0</span><span style="color: #6276BA;">)</span>
             cnt<span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #0000FF;">else</span>
             <span style="color: #6276BA;">(</span><span style="color: #0000FF;">set!</span> cnt <span style="color: #858580;">(</span><span style="color: #006FE0;">+</span> <span style="color: #D0372D;">1</span> cnt<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
             <span style="color: #6276BA;">(</span>f x<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    mf<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">s</span> <span style="color: #7388D6;">(</span>make-monitored <span style="color: #006FE0;">sqrt</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>s <span style="color: #D0372D;">100</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>s <span style="color: #D0372D;">'how-many-calls?</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>s <span style="color: #D0372D;">10</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>s <span style="color: #D0372D;">10</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>s <span style="color: #D0372D;">10</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>s <span style="color: #D0372D;">10</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>s <span style="color: #D0372D;">'how-many-calls?</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>s <span style="color: #D0372D;">'how-many-calls?</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>s <span style="color: #D0372D;">'how-many-calls?</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>s <span style="color: #D0372D;">'reset-counter</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>s <span style="color: #D0372D;">'how-many-calls?</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc59203b" class="outline-4">
<h4 id="orgc59203b">Exercise 3.3 - password-protected accounts</h4>
<div class="outline-text-4" id="text-orgc59203b">
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-account</span> amount password<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">withdraw</span> a<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">begin</span>
          <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">&gt;</span> amount a<span style="color: #907373;">)</span>
              <span style="color: #907373;">(</span><span style="color: #0000FF;">begin</span>
                <span style="color: #6276BA;">(</span><span style="color: #0000FF;">set!</span> amount <span style="color: #858580;">(</span><span style="color: #006FE0;">-</span> amount a<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                amount<span style="color: #907373;">)</span>
              <span style="color: #008000;">"Insufficient funds"</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">deposit</span> a<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">begin</span>
          <span style="color: #709870;">(</span><span style="color: #0000FF;">set!</span> amount <span style="color: #907373;">(</span><span style="color: #006FE0;">+</span> amount a<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
          amount<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">incorrect-password</span> a<span style="color: #909183;">)</span>
    <span style="color: #008000;">"Incorrect password"</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">dispatch</span> p m<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">eq?</span> p password<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'withdraw</span><span style="color: #6276BA;">)</span> withdraw<span style="color: #907373;">)</span>
              <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'deposit</span><span style="color: #6276BA;">)</span> deposit<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
        incorrect-password<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  dispatch<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">acc</span> <span style="color: #7388D6;">(</span>make-account <span style="color: #D0372D;">100</span> <span style="color: #D0372D;">'secret</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>acc <span style="color: #D0372D;">'secret</span> <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">10</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>acc <span style="color: #D0372D;">'secret</span> <span style="color: #D0372D;">'deposit</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">100</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>acc <span style="color: #D0372D;">'secret</span> <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">1000</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>acc <span style="color: #D0372D;">'pecret</span> <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">190</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1fbf9f4" class="outline-4">
<h4 id="org1fbf9f4">Exercise 3.4 - password-protected accounts with cops</h4>
<div class="outline-text-4" id="text-org1fbf9f4">
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">call-the-cops</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">display</span> <span style="color: #008000;">"[police called]"</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">newline</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-account</span> amount password<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #BA36A5;">incorrect-password-count</span> <span style="color: #D0372D;">0</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #709870;">(</span><span style="color: #006699;">withdraw</span> a<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">begin</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">if</span> <span style="color: #6276BA;">(</span><span style="color: #006FE0;">&gt;</span> amount a<span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">begin</span>
              <span style="color: #858580;">(</span><span style="color: #0000FF;">set!</span> amount <span style="color: #80A880;">(</span><span style="color: #006FE0;">-</span> amount a<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
              amount<span style="color: #6276BA;">)</span>
            <span style="color: #008000;">"Insufficient funds"</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>

    <span style="color: #909183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #709870;">(</span><span style="color: #006699;">deposit</span> a<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">begin</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">set!</span> amount <span style="color: #6276BA;">(</span><span style="color: #006FE0;">+</span> amount a<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        amount<span style="color: #709870;">)</span><span style="color: #909183;">)</span>

    <span style="color: #909183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #709870;">(</span><span style="color: #006699;">dispatch</span> p m<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">not</span> <span style="color: #6276BA;">(</span><span style="color: #006FE0;">eq?</span> p password<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span><span style="color: #0000FF;">begin</span>
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">set!</span> incorrect-password-count <span style="color: #858580;">(</span><span style="color: #006FE0;">+</span> <span style="color: #D0372D;">1</span> incorrect-password-count<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">if</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">&gt;</span> incorrect-password-count <span style="color: #D0372D;">7</span><span style="color: #858580;">)</span>
                <span style="color: #858580;">(</span>call-the-cops<span style="color: #858580;">)</span>
                <span style="color: #006FE0;">false</span><span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #858580;">(</span>x<span style="color: #858580;">)</span> <span style="color: #008000;">"Incorrect password"</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span><span style="color: #0000FF;">begin</span>
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">set!</span> incorrect-password-count <span style="color: #D0372D;">0</span><span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #858580;">(</span><span style="color: #80A880;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'withdraw</span><span style="color: #80A880;">)</span> withdraw<span style="color: #858580;">)</span>
                  <span style="color: #858580;">(</span><span style="color: #80A880;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'deposit</span><span style="color: #80A880;">)</span> deposit<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    dispatch<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">acc</span> <span style="color: #7388D6;">(</span>make-account <span style="color: #D0372D;">100</span> <span style="color: #D0372D;">'secret</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>acc <span style="color: #D0372D;">'secret</span> <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">10</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>acc <span style="color: #D0372D;">'secret</span> <span style="color: #D0372D;">'deposit</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">100</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>acc <span style="color: #D0372D;">'secret</span> <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">1000</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>acc <span style="color: #D0372D;">'pecret</span> <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">190</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>acc <span style="color: #D0372D;">'pecret</span> <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">190</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>acc <span style="color: #D0372D;">'pecret</span> <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">190</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>acc <span style="color: #D0372D;">'pecret</span> <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">190</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>acc <span style="color: #D0372D;">'pecret</span> <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">190</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>acc <span style="color: #D0372D;">'pecret</span> <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">190</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>acc <span style="color: #D0372D;">'pecret</span> <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">190</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>acc <span style="color: #D0372D;">'pecret</span> <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">190</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>acc <span style="color: #D0372D;">'pecret</span> <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">190</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>acc <span style="color: #D0372D;">'secret</span> <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">1000</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>acc <span style="color: #D0372D;">'pecret</span> <span style="color: #D0372D;">'withdraw</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">190</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5583c9b" class="outline-3">
<h3 id="org5583c9b">3.1.2 The Benefits of Introducing Assignment</h3>
<div class="outline-text-3" id="text-org5583c9b">
<p>
Introducing assignment leads us into a thicket of difficult conceptual issues. Nevertheless, viewing our system as a collection of objects with local state is a powerful technique for maintaining a modular design.
</p>

<p>
Consider the design of a procedure <code>rand</code>, that, whenever it is called, returns an integer chosen at random.
</p>

<p>
We want successive calls to <code>rand</code> to produce a sequence of numbers having certain statistical properties (uniform distribution).
</p>

<p>
To not focus on method of generating such sequences, assume we have a procedure <code>rand-update</code>, such that <code>x2 = (rand-update x1)</code>, <code>x3 = (rand-update x2)</code> and so on, where <code>x1, x2, x3, ...</code> sequence has the uniform distribution.
</p>

<p>
We can implement <code>rand</code> as a procedure with a local state variable <code>x</code>:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">rand</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #BA36A5;">x</span> random-init<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">()</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">set!</span> x <span style="color: #907373;">(</span>rand-update x<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      x<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Of course, we could generate the same sequence of random numbers without using local variable by simply calling <code>rand-update</code> directly. But then any part of our program that used random numbers would have to explicitly remember the current value of x to be passed as an argument to <code>rand-update</code>.
</p>

<p>
Consider using random numbers to imlement a technique called <i>Monte Carlo simulation</i>.
</p>

<p>
The Monte Carlo method consists of choosing sample experiments at random from a large set and then making deductions on the basis of the probabilities estimated from tabulating the results of those experiments.
</p>

<p>
For example, we can appoximate \(\pi\) using the fact that \(6/\pi^2\) is the probability that two integers choosen at random will have no factors in common; that is that their gcd is 1. To obtain the approximation to \(\pi\), we perform a large number of experiments. In each experiment we choose two integers at random and perform a test to see if their GCDs is 1. The fraction of times that the test is passed gives us our estimate of \(6/\pi^2\).
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #0000FF;">#lang</span> <span style="color: #BA36A5;">sicp</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">estimate-pi</span> trials<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">sqrt</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">/</span> <span style="color: #D0372D;">6</span> <span style="color: #709870;">(</span>monte-carlo trials cesaro-test<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">cesaro-test</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">=</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">gcd</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">random</span> <span style="color: #D0372D;">1000000000</span><span style="color: #709870;">)</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">random</span> <span style="color: #D0372D;">1000000000</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span> <span style="color: #D0372D;">1</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">monte-carlo</span> trials experiment<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">iter</span> trials-remaining trials-passed<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #006FE0;">=</span> trials-remaining <span style="color: #D0372D;">0</span><span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span><span style="color: #006FE0;">/</span> trials-passed trials<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #907373;">(</span>experiment<span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span>iter <span style="color: #6276BA;">(</span><span style="color: #006FE0;">-</span> trials-remaining <span style="color: #D0372D;">1</span><span style="color: #6276BA;">)</span> <span style="color: #6276BA;">(</span><span style="color: #006FE0;">+</span> trials-passed <span style="color: #D0372D;">1</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #0000FF;">else</span>
           <span style="color: #907373;">(</span>iter <span style="color: #6276BA;">(</span><span style="color: #006FE0;">-</span> trials-remaining <span style="color: #D0372D;">1</span><span style="color: #6276BA;">)</span> trials-passed<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>iter trials <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>estimate-pi <span style="color: #D0372D;">10000000</span><span style="color: #707183;">)</span>
</pre>
</div>

<pre class="example">
3.141585423607398
</pre>


<p>
Alternatively, using <code>rand-update</code>:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">random-init</span> <span style="color: #D0372D;">10</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">estimate-pi</span> trials<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">sqrt</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">/</span> <span style="color: #D0372D;">6</span> <span style="color: #709870;">(</span>random-gcd-test trials random-init<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">random-gcd-test</span> trials initial-x<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">iter</span> trials-remaining trials-passed x<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">let</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #BA36A5;">x1</span> <span style="color: #6276BA;">(</span>rand-update x<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #BA36A5;">x2</span> <span style="color: #858580;">(</span>rand-update x1<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span><span style="color: #006FE0;">=</span> trials-remaining <span style="color: #D0372D;">0</span><span style="color: #858580;">)</span>
               <span style="color: #858580;">(</span><span style="color: #006FE0;">/</span> trials-passed trials<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
              <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span><span style="color: #006FE0;">=</span> <span style="color: #80A880;">(</span><span style="color: #006FE0;">gcd</span> x1 x2<span style="color: #80A880;">)</span> <span style="color: #D0372D;">1</span><span style="color: #858580;">)</span>
               <span style="color: #858580;">(</span>iter <span style="color: #80A880;">(</span><span style="color: #006FE0;">-</span> trials-remaining <span style="color: #D0372D;">1</span><span style="color: #80A880;">)</span>
                     <span style="color: #80A880;">(</span><span style="color: #006FE0;">+</span> trials-passed <span style="color: #D0372D;">1</span><span style="color: #80A880;">)</span>
                     x2<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
              <span style="color: #6276BA;">(</span><span style="color: #0000FF;">else</span>
               <span style="color: #858580;">(</span>iter <span style="color: #80A880;">(</span><span style="color: #006FE0;">-</span> trials-remaining <span style="color: #D0372D;">1</span><span style="color: #80A880;">)</span>
                     trials-passed
                     x2<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>iter trials <span style="color: #D0372D;">0</span> initial-x<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
In the version without local state, user code should manipulate the random numbers x1 and x2, and recycle x2 as the new input to <code>rand-update</code>. The explicit handling of randomness intertwines with the experiment code, and greatly constricts the system with exactly 2 random numbers, making it impossible to reuse with 1 or 3.
Even <code>esimtate-pi</code> should be aware of this random system, by supplying <code>random-init</code>.
All this makes it difficult to isolate the Monte Carlo idea so that it can be applied to other tasks.
</p>

<p>
In the first version assignment helps to encapsulate the state of the random-number generator withing the <code>rand</code> procedure, so that the details of random-number generation remaing independent of the rest of the program.
</p>

<p>
From the point of view of one part of a complex system, the other parts appear to change in time. They have hidden time-varying local state.
</p>
</div>

<div id="outline-container-org522463f" class="outline-4">
<h4 id="org522463f">Exercise 3.5 - Monte Carlo integration</h4>
<div class="outline-text-4" id="text-org522463f">
<p>
Space described by a predicate \(P(x,y)\) that is true for all points inside the region and false otherwise.
</p>

<p>
To estimate the area of the region, begin by choosing a rectangle that contains the region. The desired integral is the area of that portion of the rectangle that lies in the region.
We can estimate the integral by picking, at random, points \((x, y)\) that lie in the rectangle, and testing \(P(x,y)\) for each point. If we try this enough times, the fraction of points inside the region approximates the fraction of rectangle occupied be the region. Hence, multiplying this fraction by the area of the entire rectangle gives an estimate of the area of the region.
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #0000FF;">#lang</span> <span style="color: #BA36A5;">sicp</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">random-in-range</span> low high<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #BA36A5;">range</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">-</span> high low<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #006FE0;">+</span> low <span style="color: #709870;">(</span><span style="color: #006FE0;">random</span> <span style="color: #006FE0;">range</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">estimate-integral</span> P x1 y1 x2 y2 trials<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">experiment</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>P <span style="color: #709870;">(</span>random-in-range x1 x2<span style="color: #709870;">)</span>
       <span style="color: #709870;">(</span>random-in-range y1 y2<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>  
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">*</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">-</span> x2 x1<span style="color: #909183;">)</span>
     <span style="color: #909183;">(</span><span style="color: #006FE0;">-</span> y2 y1<span style="color: #909183;">)</span>
     <span style="color: #909183;">(</span>monte-carlo trials experiment<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">monte-carlo</span> trials experiment<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">iter</span> remaining passed<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #006FE0;">zero?</span> remaining<span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span><span style="color: #006FE0;">/</span> passed trials<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #907373;">(</span>experiment<span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span>iter <span style="color: #6276BA;">(</span><span style="color: #006FE0;">-</span> remaining <span style="color: #D0372D;">1</span><span style="color: #6276BA;">)</span> <span style="color: #6276BA;">(</span><span style="color: #006FE0;">+</span> passed <span style="color: #D0372D;">1</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #0000FF;">else</span>
           <span style="color: #907373;">(</span>iter <span style="color: #6276BA;">(</span><span style="color: #006FE0;">-</span> remaining <span style="color: #D0372D;">1</span><span style="color: #6276BA;">)</span> passed<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>iter trials <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">square</span> x<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">*</span> x x<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">in-circle</span> cx cy r<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #909183;">(</span>x y<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #006FE0;">&lt;</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">+</span> <span style="color: #907373;">(</span>square <span style="color: #6276BA;">(</span><span style="color: #006FE0;">-</span> x cx<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>square <span style="color: #6276BA;">(</span><span style="color: #006FE0;">-</span> y cy<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
       <span style="color: #709870;">(</span>square r<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>estimate-integral
 <span style="color: #7388D6;">(</span>in-circle <span style="color: #D0372D;">1.0</span> <span style="color: #D0372D;">1.0</span> <span style="color: #D0372D;">1.0</span><span style="color: #7388D6;">)</span>
 <span style="color: #D0372D;">0.0</span>
 <span style="color: #D0372D;">0.0</span>
 <span style="color: #D0372D;">2.0</span>
 <span style="color: #D0372D;">2.0</span>
 <span style="color: #D0372D;">10000000</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
<code>monte-carlo</code> is the same as used for Cesaro-based estimation, only experiment code differs.
</p>
</div>
</div>

<div id="outline-container-org07736d3" class="outline-4">
<h4 id="org07736d3">Exercise 3.6 - rand reset</h4>
<div class="outline-text-4" id="text-org07736d3">
<p>
It is useful to be able to reset a random-number generator to produce a sequence starting from a given value.
</p>

<p>
Design a new <code>rand</code> procedure that is called with an argument that is either the symbol <code>generate</code> or <code>reset</code>, and behaves as follows <code>(rand 'generate)</code> outputs a random value, and <code>((rand 'reset) &lt;new-value&gt;)</code> resets the internal state variable with the new-value.
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">rand-update</span> x<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">remainder</span>
   <span style="color: #909183;">(</span><span style="color: #006FE0;">+</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">*</span> <span style="color: #D0372D;">115249</span> x<span style="color: #709870;">)</span> <span style="color: #D0372D;">112909</span><span style="color: #909183;">)</span>
   <span style="color: #D0372D;">108301</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">random-init</span> <span style="color: #D0372D;">0</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">rand</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #BA36A5;">x</span> random-init<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>method<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">eq?</span> method <span style="color: #D0372D;">'generate</span><span style="color: #6276BA;">)</span>
             <span style="color: #6276BA;">(</span><span style="color: #0000FF;">begin</span>
               <span style="color: #858580;">(</span><span style="color: #0000FF;">set!</span> x <span style="color: #80A880;">(</span>rand-update x<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
               x<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">eq?</span> method <span style="color: #D0372D;">'reset</span><span style="color: #6276BA;">)</span>
             <span style="color: #6276BA;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #858580;">(</span>n<span style="color: #858580;">)</span>
               <span style="color: #858580;">(</span><span style="color: #0000FF;">set!</span> x n<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #0000FF;">else</span>
             <span style="color: #6276BA;">(</span><span style="color: #006FE0;">error</span> <span style="color: #008000;">"Unknown method -- RAND"</span> method<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>rand <span style="color: #D0372D;">'generate</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>rand <span style="color: #D0372D;">'generate</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>rand <span style="color: #D0372D;">'generate</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>rand <span style="color: #D0372D;">'generate</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>rand <span style="color: #D0372D;">'generate</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>rand <span style="color: #D0372D;">'reset</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">0</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>rand <span style="color: #D0372D;">'generate</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>rand <span style="color: #D0372D;">'generate</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>rand <span style="color: #D0372D;">'generate</span><span style="color: #707183;">)</span>

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0add444" class="outline-3">
<h3 id="org0add444">3.1.2 The Costs of Introducing Assignment</h3>
<div class="outline-text-3" id="text-org0add444">
<p>
As we have seen, the <code>set!</code> operation enables us to model objects that have local state. However, this advantage comes at a price.
Substitution model of procedure application is no longer adequate for interpreting programs. Moreover, no simple model with "nice" mathematical properties can be an adequate framework for dealing with objects and assignment in programming languages.
</p>

<p>
So long as we do not use assignments, two evaluations of the same procedures applied to the same arguments will produce the same results. Programming without any use of assignments is known as <i>functional programming</i>.
</p>

<p>
The trouble is that substitution is based ultimately on the notion that the symbols are essentially names for values.
</p>

<p>
&gt; But as soon as we introduce <code>set!</code> and the idea the the value of a variable can change, a variable can no longer be simply a name.
Without <code>set!</code>: name -&gt; value.
With <code>set!</code>: name -&gt; variable -&gt; value.
</p>

<p>
Now, variable refer to some place where the value is stored and can be changed. Environments play this role of "place".
</p>
</div>

<div id="outline-container-orgfcc4304" class="outline-4">
<h4 id="orgfcc4304">Sameness and change</h4>
<div class="outline-text-4" id="text-orgfcc4304">
<p>
Introducing change into computational model renders what was previously straightforward as problematic. Consider the concept of two things being "the same".
</p>

<p>
Without <code>set!</code>: if two values are created by the same expression, they are "the same", meaning they are computationally equivalent and can be substituted one for the other.
With <code>set!</code>: even if two variables are created by the same expression, they are not "the same", they may have different histories, and hold different local state variables. The can <i>not</i> be substituted one for the other.
</p>

<p>
A language that supports the concept that "equals can be substituted for equals" in an expressions without changing the value of expression is said to be <i>referentially transparent</i>.
</p>

<p>
Reasoning about the programs that contain assignment becomes drastically more difficult.
</p>

<p>
In real world, to decide if two apparently identical objects are the "same", one has to change one object and observe the other changed in the same way. But to determine if it's changed one has to observe "same" object at two distinct times, and detect some property change between two observations. Thus, we can not determine "change" without a priori notion of "sameness", and we cannot determine sameness without observing the change.
</p>
</div>
</div>

<div id="outline-container-orge5fd51d" class="outline-4">
<h4 id="orge5fd51d">Pitfalls of imperative programming</h4>
<div class="outline-text-4" id="text-orge5fd51d">
<p>
Programming that makes extensive use of assignment is called <i>imperative programming</i>.
</p>

<ol class="org-ol">
<li>Order of assignment is significant.</li>
<li>Concurrent execution complicates things even more.</li>
</ol>
</div>
</div>

<div id="outline-container-org2c19e1a" class="outline-4">
<h4 id="org2c19e1a">Exercise 3.7 - joint account</h4>
<div class="outline-text-4" id="text-org2c19e1a">
<p>
Define a procedue <code>make-joint</code> that takes three arguments:
</p>
<ul class="org-ul">
<li>password-protected account</li>
<li>auth password</li>
<li>another password</li>
</ul>

<p>
, and returns an additional access to original account, protected by another password.
</p>

<hr />

<p>
One solution is to wrap <code>dispatch</code> definition in a function that accepts <code>password</code>.
</p>

<p>
Probably a better one would be to provide a restricted version of dispatch to the joint account (e.g. without <code>'make-joint</code> method).
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #0000FF;">#lang</span> <span style="color: #BA36A5;">sicp</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-account</span> amount password<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">withdraw</span> a<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">&gt;=</span> amount a<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span><span style="color: #0000FF;">begin</span>
          <span style="color: #907373;">(</span><span style="color: #0000FF;">set!</span> amount <span style="color: #6276BA;">(</span><span style="color: #006FE0;">-</span> amount a<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          amount<span style="color: #709870;">)</span>
        <span style="color: #008000;">"Insufficient funds"</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">deposit</span> a<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">set!</span> amount <span style="color: #709870;">(</span><span style="color: #006FE0;">+</span> amount a<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    amount<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">make-dispatch</span> password<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #709870;">(</span><span style="color: #006699;">dispatch</span> m p<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">not</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">eq?</span> p password<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
             <span style="color: #6276BA;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #858580;">(</span>x<span style="color: #858580;">)</span> <span style="color: #008000;">"Incorrect password"</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'withdraw</span><span style="color: #6276BA;">)</span> withdraw<span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'deposit</span><span style="color: #6276BA;">)</span> deposit<span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'make-joint</span><span style="color: #6276BA;">)</span> make-dispatch<span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #0000FF;">else</span>
             <span style="color: #6276BA;">(</span><span style="color: #006FE0;">error</span> <span style="color: #008000;">"Unknown method -- MAKE-ACCOUNT"</span> m<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    dispatch<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>make-dispatch password<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-joint</span> acc verify-password new-password<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span>acc <span style="color: #D0372D;">'make-joint</span> verify-password<span style="color: #909183;">)</span> new-password<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">paul</span> <span style="color: #7388D6;">(</span>make-account <span style="color: #D0372D;">100</span> <span style="color: #D0372D;">'secret</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>paul <span style="color: #D0372D;">'withdraw</span> <span style="color: #D0372D;">'secret</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">10</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">peter</span> <span style="color: #7388D6;">(</span>make-joint paul <span style="color: #D0372D;">'secret</span> <span style="color: #D0372D;">'pecret</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>peter <span style="color: #D0372D;">'withdraw</span> <span style="color: #D0372D;">'pecret</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">90</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>paul <span style="color: #D0372D;">'withdraw</span> <span style="color: #D0372D;">'secret</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">10</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">pylyp</span> <span style="color: #7388D6;">(</span>make-joint peter <span style="color: #D0372D;">'pecret</span> <span style="color: #D0372D;">'qecret</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>pylyp <span style="color: #D0372D;">'deposit</span> <span style="color: #D0372D;">'qecret</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">100</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>paul <span style="color: #D0372D;">'withdraw</span> <span style="color: #D0372D;">'secret</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">10</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-org727f42c" class="outline-4">
<h4 id="org727f42c">Exercise 3.8 - order of evaluation</h4>
<div class="outline-text-4" id="text-org727f42c">
<p>
Define a simple procedure <code>f</code> the evaluating <code>(+ (f 0) (f 1))</code> will return 0 if the arguments evaluated left to right, and 1 if the arguments evaluated right to left.
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org7e4a71a"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">f</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #BA36A5;">s</span> <span style="color: #006FE0;">null</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>x<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">null?</span> s<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span><span style="color: #0000FF;">begin</span>
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">set!</span> s x<span style="color: #6276BA;">)</span>
            s<span style="color: #907373;">)</span>
          <span style="color: #D0372D;">0</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket">&lt;&lt;ex3.8-f&gt;&gt;
<span style="color: #707183;">(</span><span style="color: #006FE0;">+</span> <span style="color: #7388D6;">(</span>f <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>f <span style="color: #D0372D;">1</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<pre class="example">
0
</pre>


<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #707183;">(</span><span style="color: #006FE0;">+</span> <span style="color: #7388D6;">(</span>f <span style="color: #D0372D;">1</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>f <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<pre class="example">
1
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf2a2c4f" class="outline-2">
<h2 id="orgf2a2c4f">3.2 The Environment Model of Evaluation</h2>
<div class="outline-text-2" id="text-orgf2a2c4f">
<p>
Substitution model of expression evaluation:
</p>

<p>
To apply a compound procedure, evaluate the body of the procedure with each formal parameter replaced with passed argument.
</p>

<p>
With assignment, the definition is no longer adequate. A variable can no longer be considered a name for a value. Rather, variable must somehow designate the place to store the value. In a new model evaluation, these places will be maintained in structures called <i>environments</i>.
</p>

<p>
An environment is a sequence of <i>frames</i>.
</p>

<p>
Each frame is a table (possible empty) of <i>bindings</i>, which associate the variable name with the corresponding value. A single frame can contain at most one binding for each variable.
</p>

<p>
Each frame stores a pointer to its <i>enclosing environment</i>, unless, the frame is considered to be <i>global</i>.
</p>

<p>
The <i>value of a variable</i> w.r.t. an environment is the value given by the binding of the variable in the first frame in the environment that contains binding for that variable. If no frame in the sequence specifies a bindings for the variable, then the variable is said to be <i>unbound</i> in the environment.
</p>

<p>
Expressions in a programming language have no meaning on its own, only within some environment where it's evaluated.
</p>
</div>

<div id="outline-container-org89e2e53" class="outline-3">
<h3 id="org89e2e53">3.2.1 The Rules for Evaluation</h3>
<div class="outline-text-3" id="text-org89e2e53">
<p>
The overall specification for how the interpreter evaluates a combination is not changed:
</p>
<ul class="org-ul">
<li>evaluate the subexpressions of the combination</li>
<li>apply the value of the operator subexpression to the values of the operand subexpressions</li>
</ul>

<p>
The environment model of evaluation replaces a substitution model in specifying what it means to apply a compound procedure to arguments.
</p>

<p>
In the environment model of evaluation, procedure is always a pair consisting of some code and a pointer to an environment. Procedures are created in one way only: by evaluating a lambda expression. This produces a procedure whose code is obtained from the text of the lambda expression, and whose environment is the environment in which the lambda expression was evaluated to produce a procedure.
</p>

<p>
In general, <code>define</code> (which is a syntactic sugar for <code>lambda</code>) creates definitions by adding bindings to frames.
</p>

<p>
Knowing how procedures are created, here's how to apply a procedure according to environment model: To apply a procedure to arguments, create a new environment containing a frame that binds the parameters to the values of arguments. The enclosing environment of this frame is the environment specified by the procedure. Now, within a new environment evaluate the procedure body.
</p>

<p>
Summary for the environment model of procedure application:
</p>
<ul class="org-ul">
<li>the procedure object is applied to a set of arguments by constructing a frame, binding the formal parameters to the values of the arguments of the call, and then evaluating the body of the procedure in the context of the new environment constructed</li>
<li>a procedure is created by evaluating a <code>lambda</code> expression relative to a given environment. The resulting procedure is a pair constiting of the text of the <code>lambda</code> expression and the environment in which the procedure was created.</li>
</ul>

<p>
<code>define</code> creates a binding in the current environment frame and assigns to the symbol the indicated value.
Evaluating <code>set!</code> in some environment locates the binding of the variable in the environment and changes that binding to the new value. That is, it finds the first frame in the environment that contains a binding for the variable and modifies that frame. If the variable is unbound in the environment, <code>set!</code> signals an error.
</p>
</div>
</div>

<div id="outline-container-org1a6fa67" class="outline-3">
<h3 id="org1a6fa67">3.2.2 Applying Simple Procedures</h3>
<div class="outline-text-3" id="text-org1a6fa67">
<p>
&#x2026; using paper &#x2026;
</p>
</div>
</div>

<div id="outline-container-orgbb51c4e" class="outline-3">
<h3 id="orgbb51c4e">3.2.3 Frames as the Repository of Local State</h3>
<div class="outline-text-3" id="text-orgbb51c4e">
<p>
&#x2026; using paper &#x2026;
</p>
</div>
</div>

<div id="outline-container-org018f5f1" class="outline-3">
<h3 id="org018f5f1">3.2.4 Internal Definitions</h3>
<div class="outline-text-3" id="text-org018f5f1">
<p>
&#x2026; using paper &#x2026;
</p>
</div>
</div>
</div>

<div id="outline-container-org9f1ce79" class="outline-2">
<h2 id="org9f1ce79">3.3 Modeling with Mutable Data</h2>
<div class="outline-text-2" id="text-org9f1ce79">
<p>
Chapter 2 introduced the discipline of data abstraction - when data structures are specified in terms of data constructors and data selectors. But that does not address the desire to model systems composed of objects with changing state.
</p>

<p>
Thus, we also need to have means to update the state of compound object, in addition to constructing and selecting from them.
</p>

<p>
Now data abstraction has one additional category:
Constructors, selectors, <i>mutators</i>.
</p>

<p>
Data objects with defined mutators are known as <i>mutable data objects</i>.
</p>
</div>

<div id="outline-container-org3b304fd" class="outline-3">
<h3 id="org3b304fd">3.3.1 Mutable List Structure</h3>
<div class="outline-text-3" id="text-org3b304fd">
<p>
<code>cons</code>, <code>car</code>, <code>cdr</code>, <code>append</code> and <code>list</code> allow to construct and get information from the objects, but not to update them.
</p>

<p>
<code>set-car!</code> and <code>set-cdr!</code> are the primitives for updating pairs.
</p>
</div>

<div id="outline-container-orgd731660" class="outline-4">
<h4 id="orgd731660">Exercise 3.13</h4>
<div class="outline-text-4" id="text-orgd731660">
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #0000FF;">#lang</span> <span style="color: #BA36A5;">sicp</span>


<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">last-pair</span> x<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">null?</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">cdr</span> x<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
      x
      <span style="color: #909183;">(</span><span style="color: #006FE0;">last-pair</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">cdr</span> x<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-cycle</span> x<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>set-cdr! <span style="color: #909183;">(</span><span style="color: #006FE0;">last-pair</span> x<span style="color: #909183;">)</span> x<span style="color: #7388D6;">)</span>
  x<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">z</span> <span style="color: #7388D6;">(</span>make-cycle <span style="color: #909183;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'c</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

z
<span style="color: #707183;">(</span><span style="color: #006FE0;">last-pair</span> z<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8633553" class="outline-4">
<h4 id="org8633553">Exercise 3.14</h4>
<div class="outline-text-4" id="text-org8633553">
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #0000FF;">#lang</span> <span style="color: #BA36A5;">sicp</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">mystery</span> x<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">loop</span> x y<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">null?</span> x<span style="color: #709870;">)</span>
        y
        <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #BA36A5;">temp</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">cdr</span> x<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>set-cdr! x y<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>loop temp x<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>loop x '<span style="color: #909183;">()</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">v</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'c</span> <span style="color: #D0372D;">'d</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">w</span> <span style="color: #7388D6;">(</span>mystery v<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

v

w

</pre>
</div>
</div>
</div>

<div id="outline-container-org342f5c8" class="outline-4">
<h4 id="org342f5c8">Sharing and Identity</h4>
<div class="outline-text-4" id="text-org342f5c8">
<p>
Theoretical issues of "sameness" and "change" arise in practice when individual pairs are <i>shared</i> among different data objects.
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">x</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'b</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">z1</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">cons</span> x x<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
<code>z1</code> is a pair whose <code>car</code> and <code>cdr</code> both point to the same pair <code>x</code>.
</p>

<p>
In general, using <code>cons</code> to construct lists will result in an interlinked structure of pairs, in which many individual pairs are shared by many different structures.
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">z2</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'b</span><span style="color: #909183;">)</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'b</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
<code>z2</code> is a pair whose <code>car</code> and <code>cdr</code> point to two distinct pairs, each having <code>'a</code> and <code>'b</code> in its cells.
In Scheme, there is a unique symbol with any given name, so symbols are shared.
</p>

<p>
Sharing is undetectable until constructors and selectors are used, but with mutators added it becomes significant.
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">set-to-wow!</span> x<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>set-car! <span style="color: #909183;">(</span><span style="color: #006FE0;">car</span> x<span style="color: #909183;">)</span> <span style="color: #D0372D;">'wow</span><span style="color: #7388D6;">)</span>
  x<span style="color: #707183;">)</span>
</pre>
</div>

<p>
<code>(set-to-wow! z1)</code> will update <code>z1</code> to <code>((wow b) wow b)</code>.
<code>(set-to-wow! z2)</code> will update <code>z2</code> to <code>((wow b) a b)</code>.
</p>

<p>
<code>eq?</code> tests whether two objects are equal as pointers.
</p>

<p>
In general, <code>set-car!</code> and <code>set-cdr!</code> should be used with full understanding how data objects are shared.
</p>
</div>
</div>

<div id="outline-container-org6301f3f" class="outline-4">
<h4 id="org6301f3f">Exercise 3.15, 3.16</h4>
<div class="outline-text-4" id="text-org6301f3f">
<p>
&#x2026; using paper &#x2026;
</p>
</div>
</div>

<div id="outline-container-orge2cbf81" class="outline-4">
<h4 id="orge2cbf81">Exercise 3.17 - count pairs in structure</h4>
<div class="outline-text-4" id="text-orge2cbf81">
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #0000FF;">#lang</span> <span style="color: #BA36A5;">sicp</span>


<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">new-set</span><span style="color: #7388D6;">)</span> '<span style="color: #7388D6;">()</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">empty-set?</span> s<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">null?</span> s<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">size-set</span> s<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">null?</span> s<span style="color: #909183;">)</span>
      <span style="color: #D0372D;">0</span>
      <span style="color: #909183;">(</span><span style="color: #006FE0;">+</span> <span style="color: #D0372D;">1</span> <span style="color: #709870;">(</span>size-set <span style="color: #907373;">(</span><span style="color: #006FE0;">cdr</span> s<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">contains-set?</span> s x<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #006FE0;">null?</span> s<span style="color: #709870;">)</span> <span style="color: #006FE0;">false</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #006FE0;">eq?</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">car</span> s<span style="color: #907373;">)</span> x<span style="color: #709870;">)</span> <span style="color: #006FE0;">true</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #0000FF;">else</span> <span style="color: #709870;">(</span>contains-set? <span style="color: #907373;">(</span><span style="color: #006FE0;">cdr</span> s<span style="color: #907373;">)</span> x<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">add-set</span> s x<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>contains-set? s x<span style="color: #909183;">)</span>
      s
      <span style="color: #909183;">(</span><span style="color: #006FE0;">cons</span> x s<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">union-set</span> s1 s2<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #006FE0;">null?</span> s1<span style="color: #709870;">)</span> s2<span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #709870;">(</span>contains-set? s2 <span style="color: #907373;">(</span><span style="color: #006FE0;">car</span> s1<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>union-set <span style="color: #907373;">(</span><span style="color: #006FE0;">cdr</span> s1<span style="color: #907373;">)</span> s2<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #0000FF;">else</span>
         <span style="color: #709870;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">car</span> s1<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>union-set <span style="color: #6276BA;">(</span><span style="color: #006FE0;">cdr</span> s1<span style="color: #6276BA;">)</span> s2<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">count-pairs</span> x<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">recur</span> x seen<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #0000FF;">or</span> <span style="color: #6276BA;">(</span><span style="color: #006FE0;">not</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">pair?</span> x<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
               <span style="color: #6276BA;">(</span>contains-set? seen x<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
           seen<span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #0000FF;">else</span>
           <span style="color: #907373;">(</span><span style="color: #0000FF;">let</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span><span style="color: #BA36A5;">new-seen</span> <span style="color: #80A880;">(</span>add-set seen x<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
             <span style="color: #6276BA;">(</span>union-set <span style="color: #858580;">(</span>recur <span style="color: #80A880;">(</span><span style="color: #006FE0;">car</span> x<span style="color: #80A880;">)</span> new-seen<span style="color: #858580;">)</span>
                        <span style="color: #858580;">(</span>recur <span style="color: #80A880;">(</span><span style="color: #006FE0;">cdr</span> x<span style="color: #80A880;">)</span> new-seen<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>size-set <span style="color: #909183;">(</span>recur x <span style="color: #709870;">(</span>new-set<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>count-pairs <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'c</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>count-pairs <span style="color: #7388D6;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'b</span><span style="color: #909183;">)</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'b</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">x</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'b</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>count-pairs <span style="color: #7388D6;">(</span><span style="color: #006FE0;">cons</span> x x<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">last-pair</span> xs<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">null?</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">cdr</span> xs<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
      xs
      <span style="color: #909183;">(</span><span style="color: #006FE0;">last-pair</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">cdr</span> xs<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-cycle</span> x<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>set-cdr! <span style="color: #909183;">(</span><span style="color: #006FE0;">last-pair</span> x<span style="color: #909183;">)</span> x<span style="color: #7388D6;">)</span>
  x<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>count-pairs <span style="color: #7388D6;">(</span>make-cycle x<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1446cc1" class="outline-4">
<h4 id="org1446cc1">Exercise 3.18 - detect cycle</h4>
<div class="outline-text-4" id="text-org1446cc1">
<p>
Write a procedure that examines a list and determines whether it contains a cycle.
</p>
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #0000FF;">#lang</span> <span style="color: #BA36A5;">sicp</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">detect-cycle</span> x<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">iter</span> y<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #006FE0;">null?</span> y<span style="color: #907373;">)</span> <span style="color: #006FE0;">false</span><span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #006FE0;">eq?</span> y x<span style="color: #907373;">)</span> <span style="color: #006FE0;">true</span><span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #0000FF;">else</span>
           <span style="color: #907373;">(</span>iter <span style="color: #6276BA;">(</span><span style="color: #006FE0;">cdr</span> y<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">null?</span> x<span style="color: #909183;">)</span>
      <span style="color: #006FE0;">false</span>
      <span style="color: #909183;">(</span>iter <span style="color: #709870;">(</span><span style="color: #006FE0;">cdr</span> x<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">last-pair</span> x<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">null?</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">cdr</span> x<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
      x
      <span style="color: #909183;">(</span><span style="color: #006FE0;">last-pair</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">cdr</span> x<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-cycle</span> x<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>set-cdr! <span style="color: #909183;">(</span><span style="color: #006FE0;">last-pair</span> x<span style="color: #909183;">)</span> x<span style="color: #7388D6;">)</span>
  x<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>detect-cycle <span style="color: #7388D6;">(</span>make-cycle '<span style="color: #909183;">(</span>a b c<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>detect-cycle '<span style="color: #7388D6;">(</span>a b c<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org71f8dab" class="outline-4">
<h4 id="org71f8dab">Exercise 3.19 - detect cycle in constant space</h4>
<div class="outline-text-4" id="text-org71f8dab">
<p>
My solution in 3.18 already consumes constant space besides the size of the input list.
</p>
</div>
</div>

<div id="outline-container-org5d95462" class="outline-4">
<h4 id="org5d95462">Mutation is just assignment</h4>
<div class="outline-text-4" id="text-org5d95462">
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">cons</span> x y<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">set-x!</span> v<span style="color: #909183;">)</span> <span style="color: #909183;">(</span><span style="color: #0000FF;">set!</span> x v<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">set-y!</span> v<span style="color: #909183;">)</span> <span style="color: #909183;">(</span><span style="color: #0000FF;">set!</span> y v<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">dispatch</span> m<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'car</span><span style="color: #907373;">)</span> x<span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'cdr</span><span style="color: #907373;">)</span> y<span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'set-car!</span><span style="color: #907373;">)</span> set-x!<span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'set-cdr!</span><span style="color: #907373;">)</span> set-y!<span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #0000FF;">else</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">error</span> <span style="color: #008000;">"Unknown message -- CONS"</span> m<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  dispatch<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">car</span> x<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>x <span style="color: #D0372D;">'car</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">cdr</span> x<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>x <span style="color: #D0372D;">'cdr</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">set-car!</span> x v<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span>x <span style="color: #D0372D;">'set-car!</span><span style="color: #909183;">)</span> v<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">set-cdr!</span> x v<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span>x <span style="color: #D0372D;">'set-cdr!</span><span style="color: #909183;">)</span> v<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
<code>Cons</code> can be implemented using only <code>set!</code> and local state.
</p>
</div>
</div>

<div id="outline-container-org8112892" class="outline-4">
<h4 id="org8112892">Exercise 3.20 - environment diagrams for <code>cons</code></h4>
<div class="outline-text-4" id="text-org8112892">

<div id="orge11688c" class="figure">
<p><img src="./images/Exercise-3.20.jpeg" alt="Exercise-3.20.jpeg" width="100%" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org39e1014" class="outline-3">
<h3 id="org39e1014">3.3.2 Representing Queues</h3>
<div class="outline-text-3" id="text-org39e1014">
<p>
A <i>queue</i> is a sequence in which items are inserted at one end (the <i>rear</i> of the queue) and deleted from the other end (the <i>front</i>).
</p>

<p>
Queue operations:
</p>
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">q</span> <span style="color: #7388D6;">(</span>make-queue<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>insert-queue! q <span style="color: #D0372D;">'a</span><span style="color: #707183;">)</span>  <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">a</span>
<span style="color: #707183;">(</span>insert-queue! q <span style="color: #D0372D;">'b</span><span style="color: #707183;">)</span>  <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">a b</span>
<span style="color: #707183;">(</span>delete-queue! q<span style="color: #707183;">)</span>     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">b</span>
<span style="color: #707183;">(</span>insert-queue! q <span style="color: #D0372D;">'c</span><span style="color: #707183;">)</span>  <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">b c</span>
<span style="color: #707183;">(</span>insert-queue! q <span style="color: #D0372D;">'d</span><span style="color: #707183;">)</span>  <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">b c d</span>
<span style="color: #707183;">(</span>delete-queue! q<span style="color: #707183;">)</span>     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">c d</span>
</pre>
</div>

<p>
Data abstraction:
</p>
<ul class="org-ul">
<li><p>
a constructor
</p>

<p>
<code>(make-queue)</code> - returns an empty queue
</p></li>
<li><p>
two selectors
</p>

<p>
<code>(empty-queue? &lt;queue&gt;)</code> - tests if the queue is empty
<code>(front-queue &lt;queue&gt;)</code> - returns the object at the front of the queue, or signals an error if the queue is empty; does not modify the queue
</p></li>
<li><p>
two mutators
</p>

<p>
<code>(insert-queue! &lt;queue&gt; &lt;item&gt;)</code> - insert the item at the rear of the queue and return mutated queue
<code>(delete-queue! &lt;queue&gt;)</code> - remove the item at the front of the queue and return mutated queue; signals an error if the queue is empty before the deletion
</p></li>
</ul>

<p>
We could represent a queue as a list - let the <code>car</code> of the list be the front end of the queue, and the last item of the lis be the rear end of the queue. Then to delete an item would just mean taking <code>car</code> of a list, and inserting a new element would mean appending it at the end of the list.
</p>

<p>
With list, though, it would take \(O(n)\) steps to find append an element, which is inefficient.
</p>

<p>
To overcome this inefficiency we can store the pointer to the last pair of the list. Then to insert an element we can consult the rear pointer and avoid scanning the list.
</p>

<p>
A queue represented then as a pair of pointers <code>front-ptr</code> and <code>rear-ptr</code>, which indicate, respectively, the first and the last pair in the queue. We can use <code>cons</code> to combine two pointers.
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org5129342"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">front-ptr</span> queue<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">car</span> queue<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">rear-ptr</span> queue<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">cdr</span> queue<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">set-front-ptr!</span> queue item<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>set-car! queue item<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">set-rear-ptr!</span> queue item<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>set-cdr! queue item<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket" id="orga088abd">
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-queue</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">cons</span> '<span style="color: #909183;">()</span> '<span style="color: #909183;">()</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">empty-queue?</span> queue<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">null?</span> <span style="color: #909183;">(</span>front-ptr queue<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">front-queue</span> queue<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>empty-queue? queue<span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span><span style="color: #006FE0;">error</span> <span style="color: #008000;">"FRONT called with an empty queue"</span> queue<span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span><span style="color: #006FE0;">car</span> <span style="color: #709870;">(</span>front-ptr queue<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">insert-queue!</span> queue element<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #BA36A5;">item</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">cons</span> element '<span style="color: #6276BA;">()</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span>empty-queue? queue<span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span>set-front-ptr! queue item<span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span>set-rear-ptr! queue item<span style="color: #907373;">)</span>
           queue<span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #0000FF;">else</span>
           <span style="color: #907373;">(</span>set-cdr! <span style="color: #6276BA;">(</span>rear-ptr queue<span style="color: #6276BA;">)</span> item<span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span>set-rear-ptr! queue item<span style="color: #907373;">)</span>
           queue<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">delete-queue!</span> queue<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>empty-queue? queue<span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span><span style="color: #006FE0;">error</span> <span style="color: #008000;">"DELETE called with an empty queue"</span> queue<span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span><span style="color: #0000FF;">begin</span>
        <span style="color: #709870;">(</span>set-front-ptr! queue <span style="color: #907373;">(</span><span style="color: #006FE0;">cdr</span> <span style="color: #6276BA;">(</span>front-ptr queue<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
        queue<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">q</span> <span style="color: #7388D6;">(</span>make-queue<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #0000FF;">#lang</span> <span style="color: #BA36A5;">sicp</span>

<span style="color: #707183;">(</span>insert-queue! q <span style="color: #D0372D;">'a</span><span style="color: #707183;">)</span>  <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">a</span>
<span style="color: #707183;">(</span>insert-queue! q <span style="color: #D0372D;">'b</span><span style="color: #707183;">)</span>  <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">a b</span>
<span style="color: #707183;">(</span>delete-queue! q<span style="color: #707183;">)</span>     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">b</span>
<span style="color: #707183;">(</span>insert-queue! q <span style="color: #D0372D;">'c</span><span style="color: #707183;">)</span>  <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">b c</span>
<span style="color: #707183;">(</span>insert-queue! q <span style="color: #D0372D;">'d</span><span style="color: #707183;">)</span>  <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">b c d</span>
<span style="color: #707183;">(</span>delete-queue! q<span style="color: #707183;">)</span>     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">c d</span>
</pre>
</div>

<pre class="example">
((a) a)
((a b) b)
((b) b)
((b c) c)
((b c d) d)
((c d) d)
</pre>
</div>

<div id="outline-container-org98ef365" class="outline-4">
<h4 id="org98ef365">Exercise 3.21 - queue print representation</h4>
<div class="outline-text-4" id="text-org98ef365">
<p>
Problem: "Last element inserted into the queue twice. After deleting all items, <code>'b</code> is still there, so queue is not empty".
</p>

<p>
Problem reproduction example:
</p>
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #0000FF;">#lang</span> <span style="color: #BA36A5;">sicp</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">q1</span> <span style="color: #7388D6;">(</span>make-queue<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>insert-queue! q1 <span style="color: #D0372D;">'a</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>insert-queue! q1 <span style="color: #D0372D;">'b</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>delete-queue! q1<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>delete-queue! q1<span style="color: #707183;">)</span>
</pre>
</div>

<pre class="example">
((a) a)
((a b) b)
((b) b)
(() b)
</pre>
</div>

<ul class="org-ul">
<li><a id="org2400592"></a>Show why example produces the output it does<br />
<div class="outline-text-5" id="text-org2400592">
<p>
Queue is represented as a cons, with the cdr being the pointer to the rear of the queue. While the rear-ptr is not cleaned up after deleting the last element of the queue, there is no way to access it through the public interface.
</p>
</div>
</li>

<li><a id="org75a8d63"></a>Define a <code>print-queue</code> procedure<br />
<div class="outline-text-5" id="text-org75a8d63">
<div class="org-src-container">
<pre class="src src-racket" id="orge59bf0c"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">print-queue</span> queue<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">display</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">car</span> queue<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">newline</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #0000FF;">#lang</span> <span style="color: #BA36A5;">sicp</span>


<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">q1</span> <span style="color: #7388D6;">(</span>make-queue<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-queue <span style="color: #7388D6;">(</span>insert-queue! q1 <span style="color: #D0372D;">'a</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-queue <span style="color: #7388D6;">(</span>insert-queue! q1 <span style="color: #D0372D;">'b</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-queue <span style="color: #7388D6;">(</span>delete-queue! q1<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-queue <span style="color: #7388D6;">(</span>delete-queue! q1<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<pre class="example">
(a)
(a b)
(b)
()
</pre>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgf5ded57" class="outline-4">
<h4 id="orgf5ded57">Exercise 3.23 - <i>deque</i></h4>
<div class="outline-text-4" id="text-orgf5ded57">
<p>
Interface:
</p>
<ul class="org-ul">
<li><code>(make-deque)</code></li>
<li><code>(front-deque q)</code></li>
<li><code>(rear-deque q)</code></li>
<li><code>(insert-front-deque q)</code></li>
<li><code>(delete-front-deque q)</code></li>
<li><code>(insert-rear-deque q)</code></li>
<li><code>(delete-rear-deque q)</code></li>
</ul>

<p>
All operations should take \(O(1)\) time.
</p>

<p>
Similarly to the queue list-based implementation, we need to store the rear pointer. Unlike in the queue, each spot should also store the pointer to the previous spot, so in <code>(delete-rear-deque q)</code> we can efficiently update the rear pointer.
</p>



<div class="org-src-container">
<pre class="src src-racket" id="org3546cc6"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">private procedures</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">front-ptr</span> d<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">car</span> d<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">rear-ptr</span> d<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">cdr</span> d<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">set-front-ptr!</span> d spot<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>set-car! d spot<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">set-rear-ptr!</span> d spot<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>set-cdr! d spot<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">(define (make-spot v prev next) (cons v (cons prev next)))</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">(define (value spot) (car spot))</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">(define (prev-spot spot) (cadr spot))</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">(define (next-spot spot) (cddr spot))</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">(define (set-prev-spot! spot prev) (set-car! (cdr spot) prev))</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">(define (set-next-spot! spot next) (set-cdr! (cdr spot) next))</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-spot</span> v prev next<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">cons</span> v <span style="color: #909183;">(</span><span style="color: #006FE0;">cons</span> prev <span style="color: #709870;">(</span><span style="color: #006FE0;">cons</span> next '<span style="color: #907373;">()</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">value</span> spot<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">car</span> spot<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">prev-spot</span> spot<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">cadr</span> spot<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">next-spot</span> spot<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">caddr</span> spot<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">set-prev-spot!</span> spot prev<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>set-car! <span style="color: #909183;">(</span><span style="color: #006FE0;">cdr</span> spot<span style="color: #909183;">)</span> prev<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">set-next-spot!</span> spot next<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>set-car! <span style="color: #909183;">(</span><span style="color: #006FE0;">cddr</span> spot<span style="color: #909183;">)</span> next<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">public interface</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-deque</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">cons</span> '<span style="color: #909183;">()</span> '<span style="color: #909183;">()</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">empty-deque?</span> d<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">null?</span> <span style="color: #909183;">(</span>front-ptr d<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">front-deque</span> d<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>value <span style="color: #909183;">(</span>front-ptr d<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">rear-deque</span> d<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>value <span style="color: #909183;">(</span>rear-ptr d<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">insert-front-deque!</span> d v<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #BA36A5;">spot</span> <span style="color: #907373;">(</span>make-spot v '<span style="color: #6276BA;">()</span> '<span style="color: #6276BA;">()</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>empty-deque? d<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span><span style="color: #0000FF;">begin</span>
          <span style="color: #907373;">(</span>set-front-ptr! d spot<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>set-rear-ptr! d spot<span style="color: #907373;">)</span>
          d<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span><span style="color: #0000FF;">begin</span>
          <span style="color: #907373;">(</span>set-next-spot! spot <span style="color: #6276BA;">(</span>front-ptr d<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>set-prev-spot! <span style="color: #6276BA;">(</span>front-ptr d<span style="color: #6276BA;">)</span> spot<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>set-front-ptr! d spot<span style="color: #907373;">)</span>
          d<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">insert-rear-deque!</span> d v<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #BA36A5;">spot</span> <span style="color: #907373;">(</span>make-spot v '<span style="color: #6276BA;">()</span> '<span style="color: #6276BA;">()</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>empty-deque? d<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span><span style="color: #0000FF;">begin</span>
          <span style="color: #907373;">(</span>set-front-ptr! d spot<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>set-rear-ptr! d spot<span style="color: #907373;">)</span>
          d<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span><span style="color: #0000FF;">begin</span>
          <span style="color: #907373;">(</span>set-prev-spot! spot <span style="color: #6276BA;">(</span>rear-ptr d<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>set-next-spot! <span style="color: #6276BA;">(</span>rear-ptr d<span style="color: #6276BA;">)</span> spot<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>set-rear-ptr! d spot<span style="color: #907373;">)</span>
          d<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">delete-front-deque!</span> d<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>empty-deque? d<span style="color: #709870;">)</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">error</span> <span style="color: #008000;">"DELETE called with empty queue"</span> d<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #006FE0;">null?</span> <span style="color: #907373;">(</span>next-spot <span style="color: #6276BA;">(</span>front-ptr d<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>set-front-ptr! d '<span style="color: #907373;">()</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>set-rear-ptr! d '<span style="color: #907373;">()</span><span style="color: #709870;">)</span>
         d<span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #0000FF;">else</span>
         <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #BA36A5;">new-front</span> <span style="color: #858580;">(</span>next-spot <span style="color: #80A880;">(</span>front-ptr d<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span>set-next-spot! <span style="color: #6276BA;">(</span>front-ptr d<span style="color: #6276BA;">)</span> '<span style="color: #6276BA;">()</span><span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span>set-prev-spot! new-front '<span style="color: #6276BA;">()</span><span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span>set-front-ptr! d new-front<span style="color: #907373;">)</span>
           d<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">delete-rear-deque!</span> d<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>empty-deque? d<span style="color: #709870;">)</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">error</span> <span style="color: #008000;">"DELETE called with empty queue"</span> d<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #006FE0;">null?</span> <span style="color: #907373;">(</span>prev-spot <span style="color: #6276BA;">(</span>rear-ptr d<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>set-front-ptr! d '<span style="color: #907373;">()</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>set-rear-ptr! d '<span style="color: #907373;">()</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #0000FF;">else</span>
         <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #BA36A5;">new-rear</span> <span style="color: #858580;">(</span>prev-spot <span style="color: #80A880;">(</span>rear-ptr d<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span>set-prev-spot! <span style="color: #6276BA;">(</span>rear-ptr d<span style="color: #6276BA;">)</span> '<span style="color: #6276BA;">()</span><span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span>set-next-spot! new-rear '<span style="color: #6276BA;">()</span><span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span>set-rear-ptr! d new-rear<span style="color: #907373;">)</span>
           d<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">print-deque</span> d<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">iter</span> spot vals<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">null?</span> spot<span style="color: #709870;">)</span>
        vals
        <span style="color: #709870;">(</span>iter <span style="color: #907373;">(</span>prev-spot spot<span style="color: #907373;">)</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #6276BA;">(</span>value spot<span style="color: #6276BA;">)</span> vals<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">display</span> <span style="color: #909183;">(</span>iter <span style="color: #709870;">(</span>rear-ptr d<span style="color: #709870;">)</span> '<span style="color: #709870;">()</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">newline</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #0000FF;">#lang</span> <span style="color: #BA36A5;">sicp</span>



<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">d</span> <span style="color: #7388D6;">(</span>make-deque<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
d
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>insert-front-deque! d <span style="color: #D0372D;">'a</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>insert-rear-deque! d <span style="color: #D0372D;">'b</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>insert-rear-deque! d <span style="color: #D0372D;">'c</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>delete-front-deque! d<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>delete-rear-deque! d<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>delete-front-deque! d<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
d
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">(print-deque (delete-front-deque! d))</span>
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>insert-front-deque! d <span style="color: #D0372D;">'a</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>insert-front-deque! d <span style="color: #D0372D;">'b</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>insert-front-deque! d <span style="color: #D0372D;">'c</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>insert-front-deque! d <span style="color: #D0372D;">'d</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>insert-front-deque! d <span style="color: #D0372D;">'e</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>insert-front-deque! d <span style="color: #D0372D;">'f</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>front-deque d<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>rear-deque d<span style="color: #707183;">)</span>
d
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>insert-rear-deque! d '<span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>delete-front-deque! d<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>delete-front-deque! d<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>delete-front-deque! d<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>delete-front-deque! d<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>delete-front-deque! d<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>delete-front-deque! d<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>print-deque <span style="color: #7388D6;">(</span>delete-front-deque! d<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
d
</pre>
</div>

<pre class="example" id="orgdca7b40">
(())
(a)
(a b)
(a b c)
(b c)
(b)
()
(())
(a)
(b a)
(c b a)
(d c b a)
(e d c b a)
(f e d c b a)
f
a
(#0=(f () #1=(e #0# #2=(d #1# #3=(c #2# #4=(b #3# #5=(a #4# ())))))) . #5#)
(f e d c b a 0)
(e d c b a 0)
(d c b a 0)
(c b a 0)
(b a 0)
(a 0)
(0)
()
(())
</pre>
</div>
</div>
</div>

<div id="outline-container-org5359ded" class="outline-3">
<h3 id="org5359ded">3.3.3 Representing Tables</h3>
<div class="outline-text-3" id="text-org5359ded">
<p>
How to build tables as mutable data structures (e.g. as used in 2.4.3).
</p>

<p>
We implement the table as a list of records, each of which is implemented as a pair consisting of a key and the associated value.
</p>
</div>

<div id="outline-container-org60db020" class="outline-4">
<h4 id="org60db020">One-dimensional table</h4>
<div class="outline-text-4" id="text-org60db020">
<p>
The records are glued together to form a list by pairs whose <code>cars</code> point to successive records. These gluing paris are called the <i>backbone</i> of the table.
</p>

<p>
In order to have a place that we can change when we add a new record to the table, we build the table as a <i>headed list</i> - it has a special backbone pair at the beginning, which holds a dummy "record".
</p>

<p>
To find a value by key, <code>(lookup key table)</code> procedure is used. It returns the value or <code>false</code> if no key exists in the table. <code>lookup</code> uses <code>assoc</code> procedure that find the record associated with the key. <code>assoc</code> scans through the backbone pairs checking if each pair's record is associated with the key. In no such records exist, it returns false. <code>assoc</code> never touches the head of the list, working only on backbone pairs that point to real records.
</p>

<p>
To insert <code>(insert! key value table)</code> procedure is used. It also uses <code>assoc</code> to locate the record. If it exists then the value is updated using <code>set-cdr!</code>. Otherwise a new record and a backbone pair created and inserted after the head of the list. Head of the list is important to have a stable position a table variable can point to: if the new record is inserted at the beginning of the list, <code>insert!</code> would have to return a new pointer to the start of the table when adding a new record.
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org53040a5"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">assoc</span> key records<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">cond</span>
    <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #006FE0;">null?</span> records<span style="color: #709870;">)</span> <span style="color: #006FE0;">false</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #006FE0;">eq?</span> key <span style="color: #907373;">(</span><span style="color: #006FE0;">caar</span> records<span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">car</span> records<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">else</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">assoc</span> key <span style="color: #907373;">(</span><span style="color: #006FE0;">cdr</span> records<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">lookup</span> key table<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #BA36A5;">record</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">assoc</span> key <span style="color: #6276BA;">(</span><span style="color: #006FE0;">cdr</span> table<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> record
        <span style="color: #709870;">(</span><span style="color: #006FE0;">cdr</span> record<span style="color: #709870;">)</span>
        <span style="color: #006FE0;">false</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">insert!</span> key value table<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #BA36A5;">record</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">assoc</span> key <span style="color: #6276BA;">(</span><span style="color: #006FE0;">cdr</span> table<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> record
        <span style="color: #709870;">(</span>set-cdr! record value<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>set-cdr! table
                  <span style="color: #907373;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #6276BA;">(</span><span style="color: #006FE0;">cons</span> key value<span style="color: #6276BA;">)</span>
                        <span style="color: #6276BA;">(</span><span style="color: #006FE0;">cdr</span> table<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-table</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #D0372D;">'*table*</span> '<span style="color: #909183;">()</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #0000FF;">#lang</span> <span style="color: #BA36A5;">sicp</span>



<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">t</span> <span style="color: #7388D6;">(</span>make-table<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>insert! <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">1</span> t<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>insert! <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">2</span> t<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>insert! <span style="color: #D0372D;">'c</span> <span style="color: #D0372D;">3</span> t<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>insert! <span style="color: #D0372D;">'d</span> <span style="color: #D0372D;">4</span> t<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>lookup <span style="color: #D0372D;">'a</span> t<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>lookup <span style="color: #D0372D;">'d</span> t<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>lookup <span style="color: #D0372D;">'e</span> t<span style="color: #707183;">)</span>
</pre>
</div>

<pre class="example">
1
4
#f
</pre>
</div>
</div>

<div id="outline-container-org9ffdc0d" class="outline-4">
<h4 id="org9ffdc0d">Two-dimensional tables</h4>
<div class="outline-text-4" id="text-org9ffdc0d">
<p>
Each value is indexed by two keys. We can construct such table by having a single-key table indexing the first key whose <code>car</code> are single-key subtables indexing the second key. The subtables does not need a special header pair, as the key pair of the main table serves as one.
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orga76a544"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">assoc</span> key records<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #006FE0;">null?</span> records<span style="color: #709870;">)</span> <span style="color: #006FE0;">false</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #006FE0;">eq?</span> key <span style="color: #907373;">(</span><span style="color: #006FE0;">caar</span> records<span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">car</span> records<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #0000FF;">else</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">assoc</span> key <span style="color: #907373;">(</span><span style="color: #006FE0;">cdr</span> records<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">lookup</span> key-1 key-2 table<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #BA36A5;">subtable</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">assoc</span> key-1 <span style="color: #6276BA;">(</span><span style="color: #006FE0;">cdr</span> table<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> subtable
        <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #BA36A5;">record</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">assoc</span> key-2 <span style="color: #80A880;">(</span><span style="color: #006FE0;">cdr</span> subtable<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span><span style="color: #0000FF;">if</span> record
              <span style="color: #6276BA;">(</span><span style="color: #006FE0;">cdr</span> record<span style="color: #6276BA;">)</span>
              <span style="color: #006FE0;">false</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
        <span style="color: #006FE0;">false</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">insert!</span> key-1 key-2 value table<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #BA36A5;">subtable</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">assoc</span> key-1 <span style="color: #6276BA;">(</span><span style="color: #006FE0;">cdr</span> table<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> subtable
        <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #BA36A5;">record</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">assoc</span> key-2 <span style="color: #80A880;">(</span><span style="color: #006FE0;">cdr</span> subtable<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span><span style="color: #0000FF;">if</span> record
              <span style="color: #6276BA;">(</span>set-cdr! record value<span style="color: #6276BA;">)</span>
              <span style="color: #6276BA;">(</span>set-cdr! subtable
                        <span style="color: #858580;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #80A880;">(</span><span style="color: #006FE0;">cons</span> key-2 value<span style="color: #80A880;">)</span>
                              <span style="color: #80A880;">(</span><span style="color: #006FE0;">cdr</span> subtable<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>set-cdr! table
                  <span style="color: #907373;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span><span style="color: #BA36A5;">new-record</span> <span style="color: #80A880;">(</span><span style="color: #006FE0;">cons</span> key-2 value<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                         <span style="color: #858580;">(</span><span style="color: #BA36A5;">new-subtable</span> <span style="color: #80A880;">(</span><span style="color: #006FE0;">cons</span> new-record '<span style="color: #887070;">()</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                    <span style="color: #6276BA;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">cons</span> key-1 new-subtable<span style="color: #858580;">)</span>
                          <span style="color: #858580;">(</span><span style="color: #006FE0;">cdr</span> table<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #D0372D;">'ok</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-table</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #D0372D;">'*table*</span> '<span style="color: #909183;">()</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #0000FF;">#lang</span> <span style="color: #BA36A5;">sicp</span>



<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">t</span> <span style="color: #7388D6;">(</span>make-table<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>insert! <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a1</span> <span style="color: #D0372D;">10</span> t<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>insert! <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a2</span> <span style="color: #D0372D;">11</span> t<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>insert! <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a3</span> <span style="color: #D0372D;">12</span> t<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>insert! <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a4</span> <span style="color: #D0372D;">13</span> t<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>insert! <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'b1</span> <span style="color: #D0372D;">20</span> t<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>insert! <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'b2</span> <span style="color: #D0372D;">21</span> t<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>insert! <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'b3</span> <span style="color: #D0372D;">22</span> t<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>lookup <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a1</span> t<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>lookup <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a4</span> t<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>lookup <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a5</span> t<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>lookup <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'b1</span> t<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>lookup <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'b3</span> t<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>lookup <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'b4</span> t<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>lookup <span style="color: #D0372D;">'c</span> <span style="color: #D0372D;">'c1</span> t<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org099459c" class="outline-4">
<h4 id="org099459c">Creating local tables</h4>
<div class="outline-text-4" id="text-org099459c">
<div class="org-src-container">
<pre class="src src-racket" id="org492fd7e"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">assoc</span> key records<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #006FE0;">null?</span> records<span style="color: #709870;">)</span> <span style="color: #006FE0;">false</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #006FE0;">eq?</span> key <span style="color: #907373;">(</span><span style="color: #006FE0;">caar</span> records<span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">car</span> records<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #0000FF;">else</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">assoc</span> key <span style="color: #907373;">(</span><span style="color: #006FE0;">cdr</span> records<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-table</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #BA36A5;">table</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #D0372D;">'*table*</span> '<span style="color: #6276BA;">()</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #709870;">(</span><span style="color: #006699;">lookup</span> key-1 key-2<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #BA36A5;">subtable</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">assoc</span> key-1 <span style="color: #80A880;">(</span><span style="color: #006FE0;">cdr</span> table<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">if</span> subtable
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">let</span> <span style="color: #858580;">(</span><span style="color: #80A880;">(</span><span style="color: #BA36A5;">record</span> <span style="color: #887070;">(</span><span style="color: #006FE0;">assoc</span> key-2 <span style="color: #707183;">(</span><span style="color: #006FE0;">cdr</span> subtable<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
              <span style="color: #858580;">(</span><span style="color: #0000FF;">if</span> record
                  <span style="color: #80A880;">(</span><span style="color: #006FE0;">cdr</span> record<span style="color: #80A880;">)</span>
                  <span style="color: #006FE0;">false</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
            <span style="color: #006FE0;">false</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #709870;">(</span><span style="color: #006699;">insert!</span> key-1 key-2 value<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #BA36A5;">subtable</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">assoc</span> key-1 <span style="color: #80A880;">(</span><span style="color: #006FE0;">cdr</span> table<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">if</span> subtable
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">let</span> <span style="color: #858580;">(</span><span style="color: #80A880;">(</span><span style="color: #BA36A5;">record</span> <span style="color: #887070;">(</span><span style="color: #006FE0;">assoc</span> key-2 <span style="color: #707183;">(</span><span style="color: #006FE0;">cdr</span> subtable<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
              <span style="color: #858580;">(</span><span style="color: #0000FF;">if</span> record
                  <span style="color: #80A880;">(</span>set-cdr! record value<span style="color: #80A880;">)</span>
                  <span style="color: #80A880;">(</span>set-cdr! subtable <span style="color: #887070;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #707183;">(</span><span style="color: #006FE0;">cons</span> key-2 value<span style="color: #707183;">)</span>
                                           <span style="color: #707183;">(</span><span style="color: #006FE0;">cdr</span> subtable<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span>set-cdr! table
                      <span style="color: #858580;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #80A880;">(</span><span style="color: #887070;">(</span><span style="color: #BA36A5;">new-record</span> <span style="color: #707183;">(</span><span style="color: #006FE0;">cons</span> key-2 value<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                             <span style="color: #887070;">(</span><span style="color: #BA36A5;">new-subtable-records</span> <span style="color: #707183;">(</span><span style="color: #006FE0;">cons</span> new-record '<span style="color: #7388D6;">()</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                             <span style="color: #887070;">(</span><span style="color: #BA36A5;">new-subtable</span> <span style="color: #707183;">(</span><span style="color: #006FE0;">cons</span> key-1 new-subtable-records<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                        <span style="color: #80A880;">(</span><span style="color: #006FE0;">cons</span> new-subtable
                              <span style="color: #887070;">(</span><span style="color: #006FE0;">cdr</span> table<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #709870;">(</span><span style="color: #006699;">dispatch</span> m<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'lookup</span><span style="color: #6276BA;">)</span> lookup<span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'insert!</span><span style="color: #6276BA;">)</span> insert!<span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #0000FF;">else</span> <span style="color: #6276BA;">(</span><span style="color: #006FE0;">error</span> <span style="color: #008000;">"Unknown method -- TABLE"</span> m<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    dispatch<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #0000FF;">#lang</span> <span style="color: #BA36A5;">sicp</span>



<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">t</span> <span style="color: #7388D6;">(</span>make-table<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'insert!</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a1</span> <span style="color: #D0372D;">10</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'insert!</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a2</span> <span style="color: #D0372D;">11</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'insert!</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a3</span> <span style="color: #D0372D;">12</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'insert!</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a4</span> <span style="color: #D0372D;">13</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'insert!</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'b1</span> <span style="color: #D0372D;">20</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'insert!</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'b2</span> <span style="color: #D0372D;">21</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'insert!</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'b3</span> <span style="color: #D0372D;">22</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'lookup</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a1</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'lookup</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a4</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'lookup</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a5</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'lookup</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'b1</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'lookup</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'b3</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'lookup</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'b4</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'lookup</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'c</span> <span style="color: #D0372D;">'c1</span><span style="color: #707183;">)</span>
</pre>
</div>

<pre class="example">
10
13
#f
20
22
#f
#f
</pre>
</div>
</div>


<div id="outline-container-orgcc67343" class="outline-4">
<h4 id="orgcc67343">Exercise 3.24 - user-provided key comparison function</h4>
<div class="outline-text-4" id="text-orgcc67343">
<p>
Design a table constructor <code>make-table</code> that takes as an argument a <code>same-key?</code> procedure that will be used to test "equality" of keys.
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org90df75b"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-table</span> same-key?<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">assoc</span> key records<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #006FE0;">null?</span> records<span style="color: #907373;">)</span> <span style="color: #006FE0;">false</span><span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #907373;">(</span>same-key? key <span style="color: #6276BA;">(</span><span style="color: #006FE0;">caar</span> records<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">car</span> records<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #0000FF;">else</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">assoc</span> key <span style="color: #6276BA;">(</span><span style="color: #006FE0;">cdr</span> records<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #BA36A5;">table</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #D0372D;">'*table*</span> '<span style="color: #6276BA;">()</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #709870;">(</span><span style="color: #006699;">lookup</span> key-1 key-2<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #BA36A5;">subtable</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">assoc</span> key-1 <span style="color: #80A880;">(</span><span style="color: #006FE0;">cdr</span> table<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">if</span> subtable
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">let</span> <span style="color: #858580;">(</span><span style="color: #80A880;">(</span><span style="color: #BA36A5;">record</span> <span style="color: #887070;">(</span><span style="color: #006FE0;">assoc</span> key-2 <span style="color: #707183;">(</span><span style="color: #006FE0;">cdr</span> subtable<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
              <span style="color: #858580;">(</span><span style="color: #0000FF;">if</span> record
                  <span style="color: #80A880;">(</span><span style="color: #006FE0;">cdr</span> record<span style="color: #80A880;">)</span>
                  <span style="color: #006FE0;">false</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
            <span style="color: #006FE0;">false</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #709870;">(</span><span style="color: #006699;">insert!</span> key-1 key-2 value<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #BA36A5;">subtable</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">assoc</span> key-1 <span style="color: #80A880;">(</span><span style="color: #006FE0;">cdr</span> table<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">if</span> subtable
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">let</span> <span style="color: #858580;">(</span><span style="color: #80A880;">(</span><span style="color: #BA36A5;">record</span> <span style="color: #887070;">(</span><span style="color: #006FE0;">assoc</span> key-2 <span style="color: #707183;">(</span><span style="color: #006FE0;">cdr</span> subtable<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
              <span style="color: #858580;">(</span><span style="color: #0000FF;">if</span> record
                  <span style="color: #80A880;">(</span>set-cdr! record value<span style="color: #80A880;">)</span>
                  <span style="color: #80A880;">(</span>set-cdr! subtable <span style="color: #887070;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #707183;">(</span><span style="color: #006FE0;">cons</span> key-2 value<span style="color: #707183;">)</span>
                                           <span style="color: #707183;">(</span><span style="color: #006FE0;">cdr</span> subtable<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span>set-cdr! table
                      <span style="color: #858580;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #80A880;">(</span><span style="color: #887070;">(</span><span style="color: #BA36A5;">new-record</span> <span style="color: #707183;">(</span><span style="color: #006FE0;">cons</span> key-2 value<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                             <span style="color: #887070;">(</span><span style="color: #BA36A5;">new-subtable-records</span> <span style="color: #707183;">(</span><span style="color: #006FE0;">cons</span> new-record '<span style="color: #7388D6;">()</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                             <span style="color: #887070;">(</span><span style="color: #BA36A5;">new-subtable</span> <span style="color: #707183;">(</span><span style="color: #006FE0;">cons</span> key-1 new-subtable-records<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                        <span style="color: #80A880;">(</span><span style="color: #006FE0;">cons</span> new-subtable <span style="color: #887070;">(</span><span style="color: #006FE0;">cdr</span> table<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #D0372D;">'ok</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #709870;">(</span><span style="color: #006699;">dispatch</span> m<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'lookup-proc</span><span style="color: #6276BA;">)</span> lookup<span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'insert!-proc</span><span style="color: #6276BA;">)</span> insert!<span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #0000FF;">else</span> <span style="color: #6276BA;">(</span><span style="color: #006FE0;">error</span> <span style="color: #008000;">"Unknown method -- TABLE"</span> m<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    dispatch<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #0000FF;">#lang</span> <span style="color: #BA36A5;">sicp</span>



<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">t</span> <span style="color: #7388D6;">(</span>make-table <span style="color: #006FE0;">eq?</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'insert!-proc</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a1</span> <span style="color: #D0372D;">10</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'insert!-proc</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a2</span> <span style="color: #D0372D;">11</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'insert!-proc</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a3</span> <span style="color: #D0372D;">12</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'insert!-proc</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a4</span> <span style="color: #D0372D;">13</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'insert!-proc</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'b1</span> <span style="color: #D0372D;">20</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'insert!-proc</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'b2</span> <span style="color: #D0372D;">21</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'insert!-proc</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'b3</span> <span style="color: #D0372D;">22</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'lookup-proc</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a1</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'lookup-proc</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a4</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'lookup-proc</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a5</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'lookup-proc</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'b1</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'lookup-proc</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'b3</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'lookup-proc</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'b4</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t <span style="color: #D0372D;">'lookup-proc</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">'c</span> <span style="color: #D0372D;">'c1</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">t2</span> <span style="color: #7388D6;">(</span>make-table <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>k1 k2<span style="color: #709870;">)</span>
                         <span style="color: #709870;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #0000FF;">and</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">number?</span> k1<span style="color: #858580;">)</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">number?</span> k2<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                                <span style="color: #6276BA;">(</span><span style="color: #006FE0;">&lt;</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">abs</span> <span style="color: #80A880;">(</span><span style="color: #006FE0;">-</span> k1 k2<span style="color: #80A880;">)</span><span style="color: #858580;">)</span> <span style="color: #D0372D;">0.0001</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
                               <span style="color: #907373;">(</span><span style="color: #0000FF;">else</span>
                                <span style="color: #6276BA;">(</span><span style="color: #006FE0;">equal?</span> k1 k2<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t2 <span style="color: #D0372D;">'insert!-proc</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">0.001</span> <span style="color: #D0372D;">'a1</span> <span style="color: #D0372D;">10</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t2 <span style="color: #D0372D;">'lookup-proc</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">0.00105</span> <span style="color: #D0372D;">'a1</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>t2 <span style="color: #D0372D;">'lookup-proc</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">0.002</span> <span style="color: #D0372D;">'a1</span><span style="color: #707183;">)</span>
</pre>
</div>

<pre class="example" id="orgb14a74d">
ok
ok
ok
ok
ok
ok
ok
10
13
#f
20
22
#f
#f
ok
10
#f
</pre>
</div>
</div>

<div id="outline-container-orgd0a542d" class="outline-4">
<h4 id="orgd0a542d">Exercise 3.25 - table-x</h4>
<div class="outline-text-4" id="text-orgd0a542d">
<p>
Generalizing one- and two-dimensional tables, show how to implement a table in which values are stored under an arbitrary number of keys and different values may be stored under different number of keys. The <code>lookup</code> and <code>insert!</code> procedures should take as an input a list of keys used to access the table.
</p>

<hr />

<p>
There are two complications:
</p>
<ol class="org-ol">
<li>recursive access to the record</li>
<li>a key prefix can contain a value <i>and</i> a subtable</li>
</ol>

<p>
To address #2 we can model a record with three values, key, value, subtable, where value and subtable are both optional.
Records operations are abstracted with a private interface - <code>make-record</code>, <code>key-record</code>, <code>value-record</code>, <code>subtable-record</code>, <code>set-value-record!</code> and <code>set-subtable-record!</code>.
They are implemented using list of 3 items, <code>'(key value subtable)</code> and respective accessors/mutators.
</p>

<p>
Similarly to table1 and table2, table-x is implemented as a headed list, with top-level head resembling a record for uniformity.
</p>

<p>
Publicly exposed functions <code>lookup</code> and <code>insert!</code> validate that <code>keys</code> list is not empty, and call recursive implementations, <code>lookup-rec</code> and <code>insert-rec!</code> respectively.
</p>

<p>
<code>lookup-rec</code> tries to find a record associated with the first key in <code>keys</code> in the <code>parent</code> subtable. If there are none, no value with associated <code>keys</code> exists in the table and it returns <code>false</code>. If there is a record, 3 cases are possible:
</p>
<ul class="org-ul">
<li>this is the last part of the key and the record has a value, then return the value,</li>
<li>this is the last part of the key and the record has no value (record only has subtable), the return <code>false</code>,</li>
<li>this is not the last part of the key, then recursively call <code>lookup-rec</code> on this record with the rest of the keys.</li>
</ul>

<p>
<code>insert-rec!</code> tries to find a record associated with the first key in <code>keys</code> in the <code>parent</code> subtable. If there are none, helper <code>create!</code> is called that will recursively insert all missing records and backbone pairs. If there is a record and it's the final key, update the value in this record. Finally, if there is a record and there are more keys, call <code>insert-rec!</code> on the record with the rest of the keys.
</p>

<p>
<code>(create! keys value parent)</code> helper creates a new record and a new backbone pair, and inserts the pair into <code>parent</code>'s backbone. If this is the final key, update the new record's value, otherwise recursively <code>create!</code> nested structures starting from the record.
</p>

<p>
To easily inspect the table, <code>(collect-rec parent keys-prefix acc)</code> procedure can be used. <code>collect-rec</code> essentially implements a depth-first search, tracking the <code>keys-prefix</code> and accumulating <code>(keys . value)</code> pairs if a record with the value was reached (but not stopping there).
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org78bb17d"><span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #7388D6;">(</span><span style="color: #006699;">make-table-x</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">make-record</span> key value subtable<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #006FE0;">list</span> key value subtable<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">key-record</span> r<span style="color: #909183;">)</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">car</span> r<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">value-record</span> r<span style="color: #909183;">)</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">cadr</span> r<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">subtable-record</span> r<span style="color: #909183;">)</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">caddr</span> r<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">set-value-record!</span> r v<span style="color: #909183;">)</span> <span style="color: #909183;">(</span>set-car! <span style="color: #709870;">(</span><span style="color: #006FE0;">cdr</span> r<span style="color: #709870;">)</span> v<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">set-subtable-record!</span> r v<span style="color: #909183;">)</span> <span style="color: #909183;">(</span>set-car! <span style="color: #709870;">(</span><span style="color: #006FE0;">cddr</span> r<span style="color: #709870;">)</span> v<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>

  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">assoc</span> key backbone<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #006FE0;">null?</span> backbone<span style="color: #907373;">)</span> <span style="color: #006FE0;">false</span><span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #006FE0;">eq?</span> key <span style="color: #6276BA;">(</span><span style="color: #006FE0;">caar</span> backbone<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">car</span> backbone<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #0000FF;">else</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">assoc</span> key <span style="color: #6276BA;">(</span><span style="color: #006FE0;">cdr</span> backbone<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>

  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">lookup-rec</span> keys parent<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">let</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #BA36A5;">record</span> <span style="color: #6276BA;">(</span><span style="color: #006FE0;">assoc</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">car</span> keys<span style="color: #858580;">)</span> <span style="color: #858580;">(</span>subtable-record parent<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">not</span> record<span style="color: #6276BA;">)</span> <span style="color: #006FE0;">false</span><span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">null?</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">cdr</span> keys<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
             <span style="color: #6276BA;">(</span><span style="color: #0000FF;">if</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">null?</span> <span style="color: #80A880;">(</span>value-record record<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                 <span style="color: #006FE0;">false</span>
                 <span style="color: #858580;">(</span>value-record record<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #0000FF;">else</span> <span style="color: #6276BA;">(</span>lookup-rec <span style="color: #858580;">(</span><span style="color: #006FE0;">cdr</span> keys<span style="color: #858580;">)</span> record<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>

  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">create!</span> keys value parent<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #BA36A5;">new-record</span> <span style="color: #6276BA;">(</span>make-record <span style="color: #858580;">(</span><span style="color: #006FE0;">car</span> keys<span style="color: #858580;">)</span> '<span style="color: #858580;">()</span> '<span style="color: #858580;">()</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span><span style="color: #BA36A5;">new-subtable</span> <span style="color: #6276BA;">(</span><span style="color: #006FE0;">cons</span> new-record <span style="color: #858580;">(</span>subtable-record parent<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span>set-subtable-record! parent new-subtable<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">null?</span> <span style="color: #6276BA;">(</span><span style="color: #006FE0;">cdr</span> keys<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>set-value-record! new-record value<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>create! <span style="color: #6276BA;">(</span><span style="color: #006FE0;">cdr</span> keys<span style="color: #6276BA;">)</span> value new-record<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>

  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">insert-rec!</span> keys value parent<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">let</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #BA36A5;">record</span> <span style="color: #6276BA;">(</span><span style="color: #006FE0;">assoc</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">car</span> keys<span style="color: #858580;">)</span> <span style="color: #858580;">(</span>subtable-record parent<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">not</span> record<span style="color: #6276BA;">)</span>
             <span style="color: #6276BA;">(</span>create! keys value parent<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">null?</span> <span style="color: #858580;">(</span><span style="color: #006FE0;">cdr</span> keys<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
             <span style="color: #6276BA;">(</span>set-value-record! record value<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #0000FF;">else</span>
             <span style="color: #6276BA;">(</span>insert-rec! <span style="color: #858580;">(</span><span style="color: #006FE0;">cdr</span> keys<span style="color: #858580;">)</span> value record<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #D0372D;">'ok</span><span style="color: #7388D6;">)</span>

  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">define</span> <span style="color: #909183;">(</span><span style="color: #006699;">collect-rec</span> parent keys-prefix acc<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #709870;">(</span><span style="color: #006699;">iter</span> backbone acc<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">null?</span> backbone<span style="color: #907373;">)</span>
          acc
          <span style="color: #907373;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span><span style="color: #BA36A5;">record</span> <span style="color: #80A880;">(</span><span style="color: #006FE0;">car</span> backbone<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                 <span style="color: #858580;">(</span><span style="color: #BA36A5;">keys-prefix-1</span> <span style="color: #80A880;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #887070;">(</span>key-record record<span style="color: #887070;">)</span> keys-prefix<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                 <span style="color: #858580;">(</span><span style="color: #BA36A5;">acc-1</span> <span style="color: #80A880;">(</span>collect-rec record
                                     keys-prefix-1
                                     <span style="color: #887070;">(</span><span style="color: #0000FF;">if</span> <span style="color: #707183;">(</span><span style="color: #006FE0;">null?</span> <span style="color: #7388D6;">(</span>value-record record<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                                         acc
                                         <span style="color: #707183;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">reverse</span> keys-prefix-1<span style="color: #909183;">)</span>
                                                     <span style="color: #909183;">(</span>value-record record<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
                                               acc<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span>iter <span style="color: #858580;">(</span><span style="color: #006FE0;">cdr</span> backbone<span style="color: #858580;">)</span> acc-1<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>iter <span style="color: #709870;">(</span>subtable-record parent<span style="color: #709870;">)</span> acc<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>

  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #BA36A5;">root</span> <span style="color: #907373;">(</span>make-record <span style="color: #D0372D;">'*table*</span> '<span style="color: #6276BA;">()</span> '<span style="color: #6276BA;">()</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #709870;">(</span><span style="color: #006699;">lookup</span> keys<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">null?</span> keys<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span><span style="color: #006FE0;">error</span> <span style="color: #008000;">"Empty keys"</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>lookup-rec keys root<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #709870;">(</span><span style="color: #006699;">insert!</span> keys value<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span><span style="color: #006FE0;">null?</span> keys<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span><span style="color: #006FE0;">error</span> <span style="color: #008000;">"Empty keys"</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>insert-rec! keys value root<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #709870;">(</span><span style="color: #006699;">print-table</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #006FE0;">display</span> <span style="color: #907373;">(</span>collect-rec root '<span style="color: #6276BA;">()</span> '<span style="color: #6276BA;">()</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #006FE0;">newline</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>

    <span style="color: #909183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #709870;">(</span><span style="color: #006699;">dispatch</span> m<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'lookup</span><span style="color: #6276BA;">)</span> lookup<span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'insert!</span><span style="color: #6276BA;">)</span> insert!<span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #006FE0;">eq?</span> m <span style="color: #D0372D;">'print</span><span style="color: #6276BA;">)</span> <span style="color: #6276BA;">(</span>print-table<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #0000FF;">else</span> <span style="color: #6276BA;">(</span><span style="color: #006FE0;">error</span> <span style="color: #008000;">"Unknown method -- TABLE-X"</span> m<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    dispatch<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #0000FF;">#lang</span> <span style="color: #BA36A5;">sicp</span>



<span style="color: #707183;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">tab</span> <span style="color: #7388D6;">(</span>make-table-x<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>tab <span style="color: #D0372D;">'insert!</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">10</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>tab <span style="color: #D0372D;">'print</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>tab <span style="color: #D0372D;">'insert!</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a1</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">11</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>tab <span style="color: #D0372D;">'lookup</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>tab <span style="color: #D0372D;">'lookup</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a1</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>tab <span style="color: #D0372D;">'insert!</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a1</span> <span style="color: #D0372D;">'a2</span> <span style="color: #D0372D;">'a3</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">12</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>tab <span style="color: #D0372D;">'lookup</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>tab <span style="color: #D0372D;">'lookup</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a1</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>tab <span style="color: #D0372D;">'lookup</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a1</span> <span style="color: #D0372D;">'a2</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>tab <span style="color: #D0372D;">'print</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>tab <span style="color: #D0372D;">'lookup</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a1</span> <span style="color: #D0372D;">'a2</span> <span style="color: #D0372D;">'a3</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>tab <span style="color: #D0372D;">'insert!</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'a</span> <span style="color: #D0372D;">'a1</span> <span style="color: #D0372D;">'a2</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">13</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>tab <span style="color: #D0372D;">'insert!</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'b</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">10</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>tab <span style="color: #D0372D;">'insert!</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'a1</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">11</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>tab <span style="color: #D0372D;">'insert!</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'a1</span> <span style="color: #D0372D;">'a2</span> <span style="color: #D0372D;">'a3</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">12</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>tab <span style="color: #D0372D;">'insert!</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'a1</span> <span style="color: #D0372D;">'a2</span><span style="color: #7388D6;">)</span> <span style="color: #D0372D;">13</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>tab <span style="color: #D0372D;">'lookup</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">list</span> <span style="color: #D0372D;">'b</span> <span style="color: #D0372D;">'a1</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>tab <span style="color: #D0372D;">'print</span><span style="color: #707183;">)</span>
</pre>
</div>

<pre class="example" id="org1a66146">
ok
(((a) . 10))
ok
10
11
ok
10
11
#f
(((a a1 a2 a3) . 12) ((a a1) . 11) ((a) . 10))
12
ok
ok
ok
ok
ok
11
(((a a1 a2 a3) . 12) ((a a1 a2) . 13) ((a a1) . 11) ((a) . 10) ((b a1 a2 a3) . 12) ((b a1 a2) . 13) ((b a1) . 11) ((b) . 10))
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: LMG</p>
<p class="date">Created: 2023-07-23 Sun 23:49</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
